!function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="/build/",r(r.s=2)}([function(module,exports,__webpack_require__){var n;window,n=function(){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"M",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.M)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.M?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=10)}([function(t,e,r){"use strict";var n,i;r.d(e,"j",function(){return n}),r.d(e,"i",function(){return i}),r.d(e,"b",function(){return a}),r.d(e,"a",function(){return s}),r.d(e,"h",function(){return o}),r.d(e,"g",function(){return f}),r.d(e,"k",function(){return l}),r.d(e,"e",function(){return c}),r.d(e,"d",function(){return p}),r.d(e,"c",function(){return d}),r.d(e,"l",function(){return m}),r.d(e,"f",function(){return x}),r.d(e,"p",function(){return v}),r.d(e,"m",function(){return g}),r.d(e,"t",function(){return b}),r.d(e,"s",function(){return M}),r.d(e,"u",function(){return w}),r.d(e,"r",function(){return T}),r.d(e,"o",function(){return _}),r.d(e,"n",function(){return S}),r.d(e,"q",function(){return E});var o,a=1024,s=1024,u=1024,h=1024,f=256,l=!1,c=2048,p=16,d=12,m=!0,y=!0,x=32768,v=[1,1,1,1],g=[-1,-1,-1,-1];function b(t,e,r){void 0===r&&(r=!1),n=t,i=e,l=r}function M(t,e){o=t,f=e}function w(t,e){u=t,h=e}function T(t,e){a=t,s=e}function _(){var t="float("+255/256*(256/o)+")",e="float("+16/o/16+")";return"\nfloat readTexel8(float x, float y) {\n\tint texelId = int(x / 4.0);\n\tvec4 read = texture2D(uSamplerSprites, vec2(float(texelId) / "+u+".0, y / "+h+".0));\n\tint texelC = int(x) - texelId * 4;\n\tif (texelC == 0) return read.r * "+t+";\n\tif (texelC == 1) return read.g * "+t+";\n\tif (texelC == 2) return read.b * "+t+";\n\treturn read.a * "+t+";\n}\n\nfloat extractTexelHi(float colorComp) {\n\tint intValue = int(colorComp * 255.0);\n\treturn float(intValue / 16) * "+e+";\n}\n\nfloat extractTexelLo(float colorComp) {\n\tint intValue = int(colorComp * 255.0);\n\treturn float(intValue - (intValue / 16) * 16) * "+e+";\n\t//return float(mod(float(intValue), 16.0)) * "+e+";\n}\n\nfloat readTexel4(float x, float y) {\n\tint texelId = int(x / 8.0);\n\tvec4 read = texture2D(uSamplerSprites, vec2(float(texelId) / "+u+".0, y / "+h+".0));\n\tint texelC = int(x) - texelId * 8;\n\t\n\tif (texelC == 0) return extractTexelHi(read.r);\n\tif (texelC == 1) return extractTexelLo(read.r);\n\tif (texelC == 2) return extractTexelHi(read.g);\n\tif (texelC == 3) return extractTexelLo(read.g);\n\tif (texelC == 4) return extractTexelHi(read.b);\n\tif (texelC == 5) return extractTexelLo(read.b);\n\tif (texelC == 6) return extractTexelHi(read.a);\n\treturn extractTexelLo(read.a);\n\t//return 9.0 * "+e+";\n}"}function S(t){return void 0===t&&(t=!0),"vec4 readColorSwapBuffer(int bufferNo, float horizOffset) {\n\tvec4 read = texture2D(uSamplerOthers, vec2(("+i+".0 - horizOffset) / "+c+".0, float(bufferNo) / "+p+".0));\n\treturn texture2D(uSamplerPalettes, read.xy);\n}\n\nvec4 readPalette(highp float x, highp float y) {\n\thighp float index = x * "+o+".0 + (y * "+f+".0) * 256.0;\n\t"+(t?"if (x < "+1/o+") discard;":"")+"\n\tif (index == uColorSwaps[0]) return readColorSwapBuffer("+d+", gl_FragCoord.y);\n\tif (index == uColorSwaps[1]) return readColorSwapBuffer("+(d+1)+", gl_FragCoord.y);\n\tif (index == uColorSwaps[2]) return readColorSwapBuffer("+(d+2)+", gl_FragCoord.y);\n\tif (index == uColorSwaps[3]) return readColorSwapBuffer("+(d+3)+", gl_FragCoord.y);\n\treturn texture2D(uSamplerPalettes, vec2(x, y));\n}"}function E(t){return y?"vec4(("+t+").rgb * uEnvColor.rgb, 1)":t+" * uEnvColor"}},function(t,e,r){"use strict";r.d(e,"a",function(){return n});var n=function(){function t(){}return t.extract=function(e,r){return void 0===r&&(r=8),{a:(e=t.posterize(e,r))>>>24,b:e>>>16&255,g:e>>>8&255,r:255&e}},t.make=function(t,e,r,n){if("number"==typeof t)return"number"!=typeof n&&(n=255),"number"!=typeof r?t:Math.ceil(Math.max(0,Math.min(255,t)))|Math.ceil(Math.max(0,Math.min(255,e)))<<8|Math.ceil(Math.max(0,Math.min(255,r)))<<16|Math.ceil(Math.max(0,Math.min(255,n)))<<24;if("string"==typeof t)switch("#"!==t.charAt(0)&&(t=""),t.length){case 4:return t=parseInt(t.substring(1),16),this.extendColor12(t<<4|15);case 5:return t=parseInt(t.substring(1),16),this.extendColor12(t);case 7:return t=parseInt(t.substring(1),16),this.reversecolor(t<<8|255);case 9:return t=parseInt(t.substring(1),16),this.reversecolor(t);default:throw new Error("Invalid color string "+t)}return this.make(t.r,t.g,t.b,t.a)},t.makeFromFloat=function(t,e,r,n){return void 0===n&&(n=1),this.make(255*t,255*e,255*r,255*n)},t.makeFromHsl=function(t){var e,r,n;if(0==t.s)e=r=n=t.l;else{function i(t,e,r){return(r-=Math.floor(r))<1/6?t+6*(e-t)*r:r<.5?e:r<2/3?t+(e-t)*(2/3-r)*6:t}var o=t.l<.5?t.l*(1+t.s):t.l+t.s-t.l*t.s,a=2*t.l-o;e=i(a,o,t.h+1/3),r=i(a,o,t.h),n=i(a,o,t.h-1/3)}return this.make(255*e,255*r,255*n)},t.extendColor12=function(e){return t.reversecolor(15&e|(15&e)<<4|(240&e)<<4|(240&e)<<8|(3840&e)<<8|(3840&e)<<12|(61440&e)<<12|(61440&e)<<16)},t.posterize=function(t,e){if(2===e){var r=t>>>6&16843009|t>>>7&16843009;return(r|=r<<1)|r<<2|(t=t>>>6&50529027)<<4|t<<6}return 3===e?(r=t>>>6&50529027,(t=t>>>5&117901063)|t<<5|t<<2|r):4===e?(t=t>>>4&252645135)|t<<4:5===e?(r=t>>>5&117901063,(t=t>>>3&522133279)<<3|r):t},t.reversecolor=function(t){return(255&t)<<24|(t>>>8&255)<<16|(t>>>16&255)<<8|t>>>24&255},t.toHsl=function(t){var e,r,n=this.extract(t),i=n.r/255,o=n.g/255,a=n.b/255,s=Math.max(i,o,a),u=Math.min(i,o,a),h=(s+u)/2;if(s==u)e=r=0;else{var f=s-u;switch(r=h>.5?f/(2-s-u):f/(s+u),s){case i:e=(o-a)/f+(o<a?6:0);break;case o:e=(a-i)/f+2;break;case a:e=(i-o)/f+4}e/=6}return{h:e,s:r,l:h}},t.add=function(t,e){var r=(t>>>24)+(e>>>24),n=(t>>>16&255)+(e>>>16&255),i=(t>>>8&255)+(e>>>8&255),o=(255&t)+(255&e);return r>255&&(r=255),n>255&&(n=255),i>255&&(i=255),o>255&&(o=255),o|i<<8|n<<16|r<<24},t.sub=function(t,e){var r=(t>>>24)-(e>>>24),n=(t>>>16&255)-(e>>>16&255),i=(t>>>8&255)-(e>>>8&255),o=(255&t)-(255&e);return r<0&&(r=0),n<0&&(n=0),i<0&&(i=0),o<0&&(o=0),o|i<<8|n<<16|r<<24},t.mul=function(t,e){return(255&t)*(255&e)/255|(t>>>8&255)*(e>>>8&255)/255<<8|(t>>>16&255)*(e>>>16&255)/255<<16|(t>>>24)*(e>>>24)/255<<24},t.blend=function(t,e,r){var n=1-(r=Math.min(1,Math.max(0,r)));return(255&t)*n+(255&e)*r|(t>>>8&255)*n+(e>>>8&255)*r<<8|(t>>>16&255)*n+(e>>>16&255)*r<<16|(t>>>24)*n+(e>>>24)*r<<24},t}()},function(t,e,r){"use strict";var n={};r.r(n),r.d(n,"create",function(){return z}),r.d(n,"fromMat4",function(){return j}),r.d(n,"clone",function(){return V}),r.d(n,"copy",function(){return X}),r.d(n,"fromValues",function(){return N}),r.d(n,"set",function(){return W}),r.d(n,"identity",function(){return Y}),r.d(n,"transpose",function(){return q}),r.d(n,"invert",function(){return H}),r.d(n,"adjoint",function(){return $}),r.d(n,"determinant",function(){return G}),r.d(n,"multiply",function(){return K}),r.d(n,"translate",function(){return Z}),r.d(n,"rotate",function(){return J}),r.d(n,"scale",function(){return Q}),r.d(n,"fromTranslation",function(){return tt}),r.d(n,"fromRotation",function(){return et}),r.d(n,"fromScaling",function(){return rt}),r.d(n,"fromMat2d",function(){return nt}),r.d(n,"fromQuat",function(){return it}),r.d(n,"normalFromMat4",function(){return ot}),r.d(n,"projection",function(){return at}),r.d(n,"str",function(){return st}),r.d(n,"frob",function(){return ut}),r.d(n,"add",function(){return ht}),r.d(n,"subtract",function(){return ft}),r.d(n,"multiplyScalar",function(){return lt}),r.d(n,"multiplyScalarAndAdd",function(){return ct}),r.d(n,"exactEquals",function(){return pt}),r.d(n,"equals",function(){return dt}),r.d(n,"mul",function(){return mt}),r.d(n,"sub",function(){return yt});var i={};r.r(i),r.d(i,"create",function(){return xt}),r.d(i,"clone",function(){return vt}),r.d(i,"copy",function(){return gt}),r.d(i,"fromValues",function(){return bt}),r.d(i,"set",function(){return Mt}),r.d(i,"identity",function(){return wt}),r.d(i,"transpose",function(){return Tt}),r.d(i,"invert",function(){return _t}),r.d(i,"adjoint",function(){return St}),r.d(i,"determinant",function(){return Et}),r.d(i,"multiply",function(){return At}),r.d(i,"translate",function(){return Rt}),r.d(i,"scale",function(){return Pt}),r.d(i,"rotate",function(){return Ot}),r.d(i,"rotateX",function(){return Ft}),r.d(i,"rotateY",function(){return Bt}),r.d(i,"rotateZ",function(){return Lt}),r.d(i,"fromTranslation",function(){return Ct}),r.d(i,"fromScaling",function(){return Dt}),r.d(i,"fromRotation",function(){return Ut}),r.d(i,"fromXRotation",function(){return It}),r.d(i,"fromYRotation",function(){return kt}),r.d(i,"fromZRotation",function(){return zt}),r.d(i,"fromRotationTranslation",function(){return jt}),r.d(i,"fromQuat2",function(){return Vt}),r.d(i,"getTranslation",function(){return Xt}),r.d(i,"getScaling",function(){return Nt}),r.d(i,"getRotation",function(){return Wt}),r.d(i,"fromRotationTranslationScale",function(){return Yt}),r.d(i,"fromRotationTranslationScaleOrigin",function(){return qt}),r.d(i,"fromQuat",function(){return Ht}),r.d(i,"frustum",function(){return $t}),r.d(i,"perspective",function(){return Gt}),r.d(i,"perspectiveFromFieldOfView",function(){return Kt}),r.d(i,"ortho",function(){return Zt}),r.d(i,"lookAt",function(){return Jt}),r.d(i,"targetTo",function(){return Qt}),r.d(i,"str",function(){return te}),r.d(i,"frob",function(){return ee}),r.d(i,"add",function(){return re}),r.d(i,"subtract",function(){return ne}),r.d(i,"multiplyScalar",function(){return ie}),r.d(i,"multiplyScalarAndAdd",function(){return oe}),r.d(i,"exactEquals",function(){return ae}),r.d(i,"equals",function(){return se}),r.d(i,"mul",function(){return ue}),r.d(i,"sub",function(){return he});var o={};r.r(o),r.d(o,"create",function(){return fe}),r.d(o,"clone",function(){return le}),r.d(o,"fromValues",function(){return ce}),r.d(o,"copy",function(){return pe}),r.d(o,"set",function(){return de}),r.d(o,"add",function(){return me}),r.d(o,"subtract",function(){return ye}),r.d(o,"multiply",function(){return xe}),r.d(o,"divide",function(){return ve}),r.d(o,"ceil",function(){return ge}),r.d(o,"floor",function(){return be}),r.d(o,"min",function(){return Me}),r.d(o,"max",function(){return we}),r.d(o,"round",function(){return Te}),r.d(o,"scale",function(){return _e}),r.d(o,"scaleAndAdd",function(){return Se}),r.d(o,"distance",function(){return Ee}),r.d(o,"squaredDistance",function(){return Ae}),r.d(o,"length",function(){return Re}),r.d(o,"squaredLength",function(){return Pe}),r.d(o,"negate",function(){return Oe}),r.d(o,"inverse",function(){return Fe}),r.d(o,"normalize",function(){return Be}),r.d(o,"dot",function(){return Le}),r.d(o,"cross",function(){return Ce}),r.d(o,"lerp",function(){return De}),r.d(o,"random",function(){return Ue}),r.d(o,"transformMat2",function(){return Ie}),r.d(o,"transformMat2d",function(){return ke}),r.d(o,"transformMat3",function(){return ze}),r.d(o,"transformMat4",function(){return je}),r.d(o,"rotate",function(){return Ve}),r.d(o,"angle",function(){return Xe}),r.d(o,"zero",function(){return Ne}),r.d(o,"str",function(){return We}),r.d(o,"exactEquals",function(){return Ye}),r.d(o,"equals",function(){return qe}),r.d(o,"len",function(){return $e}),r.d(o,"sub",function(){return Ge}),r.d(o,"mul",function(){return Ke}),r.d(o,"div",function(){return Ze}),r.d(o,"dist",function(){return Je}),r.d(o,"sqrDist",function(){return Qe}),r.d(o,"sqrLen",function(){return tr}),r.d(o,"forEach",function(){return er});var a=null,s=null,u=function(t,e){this.texture=t,this.width=e.width,this.height=e.height};function h(t,e,r){var n=t.createShader(e);return t.shaderSource(n,r),t.compileShader(n),t.getShaderParameter(n,t.COMPILE_STATUS)?n:(alert("An error occurred compiling the shaders: "+t.getShaderInfoLog(n)),t.deleteShader(n),null)}function f(t,e,r){var n=h(t,t.VERTEX_SHADER,e),i=h(t,t.FRAGMENT_SHADER,r),o=t.createProgram();return t.attachShader(o,n),t.attachShader(o,i),t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)?o:(alert("Unable to initialize the shader program: "+t.getProgramInfoLog(o)),null)}function l(t,e){var r=t.createTexture(),n=new Image;return t.bindTexture(t.TEXTURE_2D,r),new Promise(function(i){n.onload=function(){return t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),i(new u(r,n))},n.src=e})}function c(t){return t.createBuffer()}function p(t,e){s||(s=t.createFramebuffer()),e?(t.bindFramebuffer(t.FRAMEBUFFER,s),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0)):t.bindFramebuffer(t.FRAMEBUFFER,null)}function d(t,e,r,n,i,o){var a=new Uint8Array(i*o*4);return p(t,e),t.readPixels(r,n,i,o,t.RGBA,t.UNSIGNED_BYTE,a),p(t,null),a}function m(t,e,r,n,i,o,a){t.bindTexture(t.TEXTURE_2D,e),t.texSubImage2D(t.TEXTURE_2D,0,r,n,i,o,t.RGBA,t.FLOAT,a)}function y(t,e){return[].concat.apply([],[t.slice(0,e),t.slice(e,2*e),t.slice(3*e,4*e),t.slice(0,1*e),t.slice(3*e,4*e),t.slice(2*e,3*e)])}var x=r(0),v=function(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,i,o=r.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(n=o.next()).done;)a.push(n.value)}catch(t){i={error:t}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return a},g=6,b=function(){function t(t,e){this.usedVertices=0,this.name=t,this.xyzp=new Float32Array(4*e),this.uv=new Float32Array(2*e),this.maxVertices=e}return Object.defineProperty(t.prototype,"firstSprite",{get:function(){return this.firstVertice/g},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"firstVertice",{get:function(){return this.maxVertices-this.usedVertices},enumerable:!0,configurable:!0}),t.prototype.getZOfObject=function(t){return this.xyzp[4*g*t+2]},t.prototype.sort=function(t){var e,r,n=this,i=(e=this.firstVertice/g,r=this.usedVertices/g,Array.from({length:r},function(t,r){return e+r}));i.sort(function(t,e){return n.getZOfObject(e)-n.getZOfObject(t)});for(var o=i.length,a=0;a<i.length;a++)this.getZOfObject(i[a])<=t&&(o=a);var s=this.xyzp.slice(),u=this.uv.slice(),h=this.firstSprite;for(a=0;a<i.length;a++)this.xyzp.set(s.subarray(4*g*i[a],4*g*(i[a]+1)),4*g*(a+h)),this.uv.set(u.subarray(2*g*i[a],2*g*(i[a]+1)),2*g*(a+h));return o},Object.defineProperty(t.prototype,"usedSprites",{get:function(){return this.usedVertices/g},enumerable:!0,configurable:!0}),t}();function M(t,e,r,n,i){var o,a;return void 0===i&&(i=!1),t=Math.max(0,Math.min(x.j,t)),r=Math.max(0,Math.min(x.j,r)),e=Math.max(0,Math.min(x.j,e)),n=Math.max(0,Math.min(x.j,n)),t>r&&(r=(o=v([t,r],2))[0],t=o[1]),e>n&&(n=(a=v([e,n],2))[0],e=a[1]),i?Math.ceil((r-t)/hr)*Math.ceil((n-e)/hr):(r-t)*(n-e)}function w(t,e,r,n){if(!(n<=r)){var i=t._,o=t.S,a=e.firstVertice;o.bindBuffer(o.ARRAY_BUFFER,i.glBuffers.xyzp),o.bufferData(o.ARRAY_BUFFER,e.xyzp.subarray(4*a),o.STREAM_DRAW),o.bindBuffer(o.ARRAY_BUFFER,i.glBuffers.uv),o.bufferData(o.ARRAY_BUFFER,e.uv.subarray(2*a),o.STREAM_DRAW),o.useProgram(i.program);var s=o.FLOAT,u=!1,h=0,f=0;o.bindBuffer(o.ARRAY_BUFFER,i.glBuffers.xyzp),o.vertexAttribPointer(i.attribLocations.xyzp,4,s,u,h,f),o.enableVertexAttribArray(i.attribLocations.xyzp),s=o.FLOAT,u=!1,h=0,f=0,o.bindBuffer(o.ARRAY_BUFFER,i.glBuffers.uv),o.vertexAttribPointer(i.attribLocations.uv,2,s,u,h,f),o.enableVertexAttribArray(i.attribLocations.uv),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,t.O),o.activeTexture(o.TEXTURE1),o.bindTexture(o.TEXTURE_2D,t.C),o.activeTexture(o.TEXTURE3),o.bindTexture(o.TEXTURE_2D,t.T),o.uniform1i(i.uniformLocations.uSamplerSprites,0),o.uniform1i(i.uniformLocations.uSamplerPalettes,1),o.uniform1i(i.uniformLocations.uSamplerOthers,3),o.uniformMatrix4fv(i.uniformLocations.projectionMatrix,!1,t.P),o.uniformMatrix3fv(i.uniformLocations.modelViewMatrix,!1,t.I),o.uniform4f(i.uniformLocations.envColor,x.p[0],x.p[1],x.p[2],x.p[3]),o.uniform4f(i.uniformLocations.colorSwaps,x.m[0],x.m[1],x.m[2],x.m[3]),o.drawArrays(o.TRIANGLES,r*g,n*g),e.usedVertices=0}}function T(t,e,r,n,i,o,a,s,u,h,f,l,c,p){var d,m;if(void 0===l&&(l=0),void 0===c&&(c=!1),void 0===p&&(p=!1),f&&(h|=x.f),t.usedVertices>=t.maxVertices)ar&&console.log(t.name+" overuse (max "+t.maxVertices/g+"), ignoring drawOBJ");else{t.usedVertices+=g;var b=t.firstVertice;c&&(o=(d=v([s,o],2))[0],s=d[1]),p&&(a=(m=v([u,a],2))[0],u=m[1]),t.xyzp.set(y([e,r,l,h,n,r,l,h,e,i,l,h,n,i,l,h],4),4*b),t.uv.set(y([o,a,s,a,o,u,s,u],2),2*b)}}function _(t,e){return new b(t,e*g)}var S=6,E=function(){function t(t,e){this.usedVertices=0,this.name=t,this.xyzp=new Float32Array(4*e),this.mapInfo1=new Float32Array(4*e),this.mapInfo2=new Float32Array(4*e),this.mapInfo3=new Float32Array(4*e),this.mapInfo4=new Float32Array(4*e),this.maxVertices=e}return Object.defineProperty(t.prototype,"firstVertice",{get:function(){return this.maxVertices-this.usedVertices},enumerable:!0,configurable:!0}),t.prototype.getZOfBG=function(t){return this.xyzp[this.firstVertice+4*S*t+2]},Object.defineProperty(t.prototype,"usedLayers",{get:function(){return this.usedVertices/S},enumerable:!0,configurable:!0}),t}();function A(t,e){if(!(e.usedVertices<3)){var r=t.S,n=t.D,i=e.firstVertice;r.bindBuffer(r.ARRAY_BUFFER,n.glBuffers.xyzp),r.bufferData(r.ARRAY_BUFFER,e.xyzp.subarray(4*i),r.STREAM_DRAW),r.bindBuffer(r.ARRAY_BUFFER,n.glBuffers.mapInfo1),r.bufferData(r.ARRAY_BUFFER,e.mapInfo1.subarray(4*i),r.STREAM_DRAW),r.bindBuffer(r.ARRAY_BUFFER,n.glBuffers.mapInfo2),r.bufferData(r.ARRAY_BUFFER,e.mapInfo2.subarray(4*i),r.STREAM_DRAW),r.bindBuffer(r.ARRAY_BUFFER,n.glBuffers.mapInfo3),r.bufferData(r.ARRAY_BUFFER,e.mapInfo3.subarray(4*i),r.STREAM_DRAW),r.bindBuffer(r.ARRAY_BUFFER,n.glBuffers.mapInfo4),r.bufferData(r.ARRAY_BUFFER,e.mapInfo4.subarray(4*i),r.STREAM_DRAW),r.useProgram(n.program);var o=r.FLOAT,a=!1,s=0,u=0;r.bindBuffer(r.ARRAY_BUFFER,n.glBuffers.xyzp),r.vertexAttribPointer(n.attribLocations.xyzp,4,o,a,s,u),r.enableVertexAttribArray(n.attribLocations.xyzp);var h=4;o=r.FLOAT,a=!1,s=0,u=0,r.bindBuffer(r.ARRAY_BUFFER,n.glBuffers.mapInfo1),r.vertexAttribPointer(n.attribLocations.mapInfo1,h,o,a,s,u),r.enableVertexAttribArray(n.attribLocations.mapInfo1),h=4,o=r.FLOAT,a=!1,s=0,u=0,r.bindBuffer(r.ARRAY_BUFFER,n.glBuffers.mapInfo2),r.vertexAttribPointer(n.attribLocations.mapInfo2,h,o,a,s,u),r.enableVertexAttribArray(n.attribLocations.mapInfo2),h=4,o=r.FLOAT,a=!1,s=0,u=0,r.bindBuffer(r.ARRAY_BUFFER,n.glBuffers.mapInfo3),r.vertexAttribPointer(n.attribLocations.mapInfo3,h,o,a,s,u),r.enableVertexAttribArray(n.attribLocations.mapInfo3),h=4,o=r.FLOAT,a=!1,s=0,u=0,r.bindBuffer(r.ARRAY_BUFFER,n.glBuffers.mapInfo4),r.vertexAttribPointer(n.attribLocations.mapInfo4,h,o,a,s,u),r.enableVertexAttribArray(n.attribLocations.mapInfo4),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,t.O),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,t.C),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,t.F),r.activeTexture(r.TEXTURE3),r.bindTexture(r.TEXTURE_2D,t.T),r.uniform1i(n.uniformLocations.uSamplerSprites,0),r.uniform1i(n.uniformLocations.uSamplerPalettes,1),r.uniform1i(n.uniformLocations.uSamplerMaps,2),r.uniform1i(n.uniformLocations.uSamplerOthers,3),r.uniformMatrix4fv(n.uniformLocations.projectionMatrix,!1,t.P),r.uniformMatrix3fv(n.uniformLocations.modelViewMatrix,!1,t.I),r.uniform4f(n.uniformLocations.envColor,x.p[0],x.p[1],x.p[2],x.p[3]),r.uniform4f(n.uniformLocations.colorSwaps,x.m[0],x.m[1],x.m[2],x.m[3]),r.drawArrays(r.TRIANGLES,0,e.usedVertices),e.usedVertices=0}}function R(t,e){return new E(t,e*S)}function P(t,e,r,n,i,o,a,s,u){var h=t.S,f=t.U,l=[e,r,n,r,e,i,n,i],c=[o,a,s,u,o,a,s,u,o,a,s,u,o,a,s,u];h.bindBuffer(h.ARRAY_BUFFER,f.glBuffers.xy),h.bufferData(h.ARRAY_BUFFER,new Float32Array(l),h.STREAM_DRAW),h.bindBuffer(h.ARRAY_BUFFER,f.glBuffers.color),h.bufferData(h.ARRAY_BUFFER,new Float32Array(c),h.STREAM_DRAW),h.useProgram(f.program);var p=h.FLOAT,d=!1,m=0,y=0;h.bindBuffer(h.ARRAY_BUFFER,f.glBuffers.xy),h.vertexAttribPointer(f.attribLocations.xy,2,p,d,m,y),h.enableVertexAttribArray(f.attribLocations.xy),p=h.FLOAT,d=!1,m=0,y=0,h.bindBuffer(h.ARRAY_BUFFER,f.glBuffers.color),h.vertexAttribPointer(f.attribLocations.color,4,p,d,m,y),h.enableVertexAttribArray(f.attribLocations.color),h.activeTexture(h.TEXTURE0),h.bindTexture(h.TEXTURE_2D,t.C),h.activeTexture(h.TEXTURE1),h.bindTexture(h.TEXTURE_2D,t.T),h.uniform1i(f.uniformLocations.uSamplerPalettes,0),h.uniform1i(f.uniformLocations.uSamplerOthers,1),h.uniform4f(f.uniformLocations.colorSwaps,x.m[0],x.m[1],x.m[2],x.m[3]),h.uniformMatrix4fv(f.uniformLocations.projectionMatrix,!1,t.P),h.uniformMatrix3fv(f.uniformLocations.modelViewMatrix,!1,t.I),y=0,h.drawArrays(h.TRIANGLE_STRIP,y,4)}var O=function(){function t(t,e,r,n,i,o){this.x=t,this.y=e,this.w=r,this.h=n,this.designTileset=i,this.designPalette=o}return t.prototype.offset=function(t,e,r,n){return this.x+=t,this.y+=e,this.w=r,this.h=n,this},t}(),F=function(){function t(t,e,r){this.y=t,this.w=e,this.h=r}return t.prototype.offset=function(t,e,r){return this.y+=t,this.w=e,this.h=r,this},t}(),B=function(){function t(t,e,r,n,i,o,a,s,u){this.x=t,this.y=e,this.w=r,this.h=n,this.tw=i,this.th=o,this.tiles=a,this.hiColor=s,this.designPalette=u}return t.prototype.offset=function(t,e,r,n){return this.x+=t,this.y+=e,this.w=r,this.h=n,this},t.prototype.tile=function(t){t=Math.floor(t);var e=Math.floor(this.w/this.tw);if(this.w/this.tw!==e)throw new Error("Not a tileset (w="+this.w+", h="+this.h+", tw="+this.tw+")");var r=t%e,n=Math.floor(t/e);return this.offset(r*this.tw,n*this.th,this.tw,this.th)},t}(),L=function(){function t(t,e,r){this.array=t,this.width=e,this.height=r}return t.prototype.getElement=function(t,e){return this.array[this.width*Math.floor(e)+Math.floor(t)]},t.prototype.setElement=function(t,e,r){this.array[this.width*Math.floor(e)+Math.floor(t)]=r},t}(),C=r(1),D=function(){function t(t,e,r,n){this.posterizeToBpp=-1,this.buffer=t,this.width=e,this.height=r,this.pixelsPerTexel=n}return t.prototype.clone=function(){var e=new t(this.buffer.slice(0),this.width,this.height,this.pixelsPerTexel);return e.posterizeToBpp=this.posterizeToBpp,e},t.prototype.readToBuffer=function(t,e,r,n,i){if(typeof this.buffer!=typeof i)throw new Error("readFromShadowTexture: dest buffer must be of same type");for(var o=this.width*this.pixelsPerTexel,a=t+e*o,s=0,u=0;u<n;u++)i.set(this.buffer.subarray(a,a+r),s),a+=o,s+=r},t.prototype.setPosterization=function(t){if(this.buffer.constructor!==Uint32Array)throw new Error("Posterization only available for color buffers (32-bit)");this.posterizeToBpp=t},t.prototype.writeTo=function(t,e,r,n,i){if(typeof this.buffer!=typeof i)throw new Error("writeToShadowTexture: data must be of same type");for(var o=this.width*this.pixelsPerTexel,a=0,s=t+e*o,u=0;u<n;u++)this.buffer.set(i.subarray(a,a+r),s),a+=r,s+=o},t.prototype.syncToVramTexture=function(e,r,n,i,o,a){o=Math.ceil(o/this.pixelsPerTexel),n%this.pixelsPerTexel>0&&(o+=1),n=Math.floor(n/this.pixelsPerTexel);var s=new Uint32Array(o*a);if(new t(new Uint32Array(this.buffer.buffer),this.width,this.height,1).readToBuffer(n,i,o,a,s),this.posterizeToBpp>=1)for(var u=0;u<s.length;u++)s[u]=C.a.posterize(s[u],this.posterizeToBpp);e.bindTexture(e.TEXTURE_2D,r),e.texSubImage2D(e.TEXTURE_2D,0,n,i,o,a,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array(s.buffer))},t}(),U=1e-6,I="undefined"!=typeof Float32Array?Float32Array:Array,k=Math.random;function z(){var t=new I(9);return I!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function j(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t}function V(t){var e=new I(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function X(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function N(t,e,r,n,i,o,a,s,u){var h=new I(9);return h[0]=t,h[1]=e,h[2]=r,h[3]=n,h[4]=i,h[5]=o,h[6]=a,h[7]=s,h[8]=u,h}function W(t,e,r,n,i,o,a,s,u,h){return t[0]=e,t[1]=r,t[2]=n,t[3]=i,t[4]=o,t[5]=a,t[6]=s,t[7]=u,t[8]=h,t}function Y(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function q(t,e){if(t===e){var r=e[1],n=e[2],i=e[5];t[1]=e[3],t[2]=e[6],t[3]=r,t[5]=e[7],t[6]=n,t[7]=i}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t}function H(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],h=e[7],f=e[8],l=f*a-s*h,c=-f*o+s*u,p=h*o-a*u,d=r*l+n*c+i*p;return d?(d=1/d,t[0]=l*d,t[1]=(-f*n+i*h)*d,t[2]=(s*n-i*a)*d,t[3]=c*d,t[4]=(f*r-i*u)*d,t[5]=(-s*r+i*o)*d,t[6]=p*d,t[7]=(-h*r+n*u)*d,t[8]=(a*r-n*o)*d,t):null}function $(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],h=e[7],f=e[8];return t[0]=a*f-s*h,t[1]=i*h-n*f,t[2]=n*s-i*a,t[3]=s*u-o*f,t[4]=r*f-i*u,t[5]=i*o-r*s,t[6]=o*h-a*u,t[7]=n*u-r*h,t[8]=r*a-n*o,t}function G(t){var e=t[0],r=t[1],n=t[2],i=t[3],o=t[4],a=t[5],s=t[6],u=t[7],h=t[8];return e*(h*o-a*u)+r*(-h*i+a*s)+n*(u*i-o*s)}function K(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],h=e[6],f=e[7],l=e[8],c=r[0],p=r[1],d=r[2],m=r[3],y=r[4],x=r[5],v=r[6],g=r[7],b=r[8];return t[0]=c*n+p*a+d*h,t[1]=c*i+p*s+d*f,t[2]=c*o+p*u+d*l,t[3]=m*n+y*a+x*h,t[4]=m*i+y*s+x*f,t[5]=m*o+y*u+x*l,t[6]=v*n+g*a+b*h,t[7]=v*i+g*s+b*f,t[8]=v*o+g*u+b*l,t}function Z(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],h=e[6],f=e[7],l=e[8],c=r[0],p=r[1];return t[0]=n,t[1]=i,t[2]=o,t[3]=a,t[4]=s,t[5]=u,t[6]=c*n+p*a+h,t[7]=c*i+p*s+f,t[8]=c*o+p*u+l,t}function J(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],h=e[6],f=e[7],l=e[8],c=Math.sin(r),p=Math.cos(r);return t[0]=p*n+c*a,t[1]=p*i+c*s,t[2]=p*o+c*u,t[3]=p*a-c*n,t[4]=p*s-c*i,t[5]=p*u-c*o,t[6]=h,t[7]=f,t[8]=l,t}function Q(t,e,r){var n=r[0],i=r[1];return t[0]=n*e[0],t[1]=n*e[1],t[2]=n*e[2],t[3]=i*e[3],t[4]=i*e[4],t[5]=i*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function tt(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t}function et(t,e){var r=Math.sin(e),n=Math.cos(e);return t[0]=n,t[1]=r,t[2]=0,t[3]=-r,t[4]=n,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function rt(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function nt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t}function it(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=r+r,s=n+n,u=i+i,h=r*a,f=n*a,l=n*s,c=i*a,p=i*s,d=i*u,m=o*a,y=o*s,x=o*u;return t[0]=1-l-d,t[3]=f-x,t[6]=c+y,t[1]=f+x,t[4]=1-h-d,t[7]=p-m,t[2]=c-y,t[5]=p+m,t[8]=1-h-l,t}function ot(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],h=e[7],f=e[8],l=e[9],c=e[10],p=e[11],d=e[12],m=e[13],y=e[14],x=e[15],v=r*s-n*a,g=r*u-i*a,b=r*h-o*a,M=n*u-i*s,w=n*h-o*s,T=i*h-o*u,_=f*m-l*d,S=f*y-c*d,E=f*x-p*d,A=l*y-c*m,R=l*x-p*m,P=c*x-p*y,O=v*P-g*R+b*A+M*E-w*S+T*_;return O?(O=1/O,t[0]=(s*P-u*R+h*A)*O,t[1]=(u*E-a*P-h*S)*O,t[2]=(a*R-s*E+h*_)*O,t[3]=(i*R-n*P-o*A)*O,t[4]=(r*P-i*E+o*S)*O,t[5]=(n*E-r*R-o*_)*O,t[6]=(m*T-y*w+x*M)*O,t[7]=(y*b-d*T-x*g)*O,t[8]=(d*w-m*b+x*v)*O,t):null}function at(t,e,r){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/r,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t}function st(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"}function ut(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))}function ht(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t[8]=e[8]+r[8],t}function ft(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t[6]=e[6]-r[6],t[7]=e[7]-r[7],t[8]=e[8]-r[8],t}function lt(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*r,t}function ct(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t[3]=e[3]+r[3]*n,t[4]=e[4]+r[4]*n,t[5]=e[5]+r[5]*n,t[6]=e[6]+r[6]*n,t[7]=e[7]+r[7]*n,t[8]=e[8]+r[8]*n,t}function pt(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]}function dt(t,e){var r=t[0],n=t[1],i=t[2],o=t[3],a=t[4],s=t[5],u=t[6],h=t[7],f=t[8],l=e[0],c=e[1],p=e[2],d=e[3],m=e[4],y=e[5],x=e[6],v=e[7],g=e[8];return Math.abs(r-l)<=U*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(n-c)<=U*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(i-p)<=U*Math.max(1,Math.abs(i),Math.abs(p))&&Math.abs(o-d)<=U*Math.max(1,Math.abs(o),Math.abs(d))&&Math.abs(a-m)<=U*Math.max(1,Math.abs(a),Math.abs(m))&&Math.abs(s-y)<=U*Math.max(1,Math.abs(s),Math.abs(y))&&Math.abs(u-x)<=U*Math.max(1,Math.abs(u),Math.abs(x))&&Math.abs(h-v)<=U*Math.max(1,Math.abs(h),Math.abs(v))&&Math.abs(f-g)<=U*Math.max(1,Math.abs(f),Math.abs(g))}Math.PI;var mt=K,yt=ft;function xt(){var t=new I(16);return I!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function vt(t){var e=new I(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function gt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function bt(t,e,r,n,i,o,a,s,u,h,f,l,c,p,d,m){var y=new I(16);return y[0]=t,y[1]=e,y[2]=r,y[3]=n,y[4]=i,y[5]=o,y[6]=a,y[7]=s,y[8]=u,y[9]=h,y[10]=f,y[11]=l,y[12]=c,y[13]=p,y[14]=d,y[15]=m,y}function Mt(t,e,r,n,i,o,a,s,u,h,f,l,c,p,d,m,y){return t[0]=e,t[1]=r,t[2]=n,t[3]=i,t[4]=o,t[5]=a,t[6]=s,t[7]=u,t[8]=h,t[9]=f,t[10]=l,t[11]=c,t[12]=p,t[13]=d,t[14]=m,t[15]=y,t}function wt(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Tt(t,e){if(t===e){var r=e[1],n=e[2],i=e[3],o=e[6],a=e[7],s=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=r,t[6]=e[9],t[7]=e[13],t[8]=n,t[9]=o,t[11]=e[14],t[12]=i,t[13]=a,t[14]=s}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function _t(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],h=e[7],f=e[8],l=e[9],c=e[10],p=e[11],d=e[12],m=e[13],y=e[14],x=e[15],v=r*s-n*a,g=r*u-i*a,b=r*h-o*a,M=n*u-i*s,w=n*h-o*s,T=i*h-o*u,_=f*m-l*d,S=f*y-c*d,E=f*x-p*d,A=l*y-c*m,R=l*x-p*m,P=c*x-p*y,O=v*P-g*R+b*A+M*E-w*S+T*_;return O?(O=1/O,t[0]=(s*P-u*R+h*A)*O,t[1]=(i*R-n*P-o*A)*O,t[2]=(m*T-y*w+x*M)*O,t[3]=(c*w-l*T-p*M)*O,t[4]=(u*E-a*P-h*S)*O,t[5]=(r*P-i*E+o*S)*O,t[6]=(y*b-d*T-x*g)*O,t[7]=(f*T-c*b+p*g)*O,t[8]=(a*R-s*E+h*_)*O,t[9]=(n*E-r*R-o*_)*O,t[10]=(d*w-m*b+x*v)*O,t[11]=(l*b-f*w-p*v)*O,t[12]=(s*S-a*A-u*_)*O,t[13]=(r*A-n*S+i*_)*O,t[14]=(m*g-d*M-y*v)*O,t[15]=(f*M-l*g+c*v)*O,t):null}function St(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],h=e[7],f=e[8],l=e[9],c=e[10],p=e[11],d=e[12],m=e[13],y=e[14],x=e[15];return t[0]=s*(c*x-p*y)-l*(u*x-h*y)+m*(u*p-h*c),t[1]=-(n*(c*x-p*y)-l*(i*x-o*y)+m*(i*p-o*c)),t[2]=n*(u*x-h*y)-s*(i*x-o*y)+m*(i*h-o*u),t[3]=-(n*(u*p-h*c)-s*(i*p-o*c)+l*(i*h-o*u)),t[4]=-(a*(c*x-p*y)-f*(u*x-h*y)+d*(u*p-h*c)),t[5]=r*(c*x-p*y)-f*(i*x-o*y)+d*(i*p-o*c),t[6]=-(r*(u*x-h*y)-a*(i*x-o*y)+d*(i*h-o*u)),t[7]=r*(u*p-h*c)-a*(i*p-o*c)+f*(i*h-o*u),t[8]=a*(l*x-p*m)-f*(s*x-h*m)+d*(s*p-h*l),t[9]=-(r*(l*x-p*m)-f*(n*x-o*m)+d*(n*p-o*l)),t[10]=r*(s*x-h*m)-a*(n*x-o*m)+d*(n*h-o*s),t[11]=-(r*(s*p-h*l)-a*(n*p-o*l)+f*(n*h-o*s)),t[12]=-(a*(l*y-c*m)-f*(s*y-u*m)+d*(s*c-u*l)),t[13]=r*(l*y-c*m)-f*(n*y-i*m)+d*(n*c-i*l),t[14]=-(r*(s*y-u*m)-a*(n*y-i*m)+d*(n*u-i*s)),t[15]=r*(s*c-u*l)-a*(n*c-i*l)+f*(n*u-i*s),t}function Et(t){var e=t[0],r=t[1],n=t[2],i=t[3],o=t[4],a=t[5],s=t[6],u=t[7],h=t[8],f=t[9],l=t[10],c=t[11],p=t[12],d=t[13],m=t[14],y=t[15];return(e*a-r*o)*(l*y-c*m)-(e*s-n*o)*(f*y-c*d)+(e*u-i*o)*(f*m-l*d)+(r*s-n*a)*(h*y-c*p)-(r*u-i*a)*(h*m-l*p)+(n*u-i*s)*(h*d-f*p)}function At(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],h=e[6],f=e[7],l=e[8],c=e[9],p=e[10],d=e[11],m=e[12],y=e[13],x=e[14],v=e[15],g=r[0],b=r[1],M=r[2],w=r[3];return t[0]=g*n+b*s+M*l+w*m,t[1]=g*i+b*u+M*c+w*y,t[2]=g*o+b*h+M*p+w*x,t[3]=g*a+b*f+M*d+w*v,g=r[4],b=r[5],M=r[6],w=r[7],t[4]=g*n+b*s+M*l+w*m,t[5]=g*i+b*u+M*c+w*y,t[6]=g*o+b*h+M*p+w*x,t[7]=g*a+b*f+M*d+w*v,g=r[8],b=r[9],M=r[10],w=r[11],t[8]=g*n+b*s+M*l+w*m,t[9]=g*i+b*u+M*c+w*y,t[10]=g*o+b*h+M*p+w*x,t[11]=g*a+b*f+M*d+w*v,g=r[12],b=r[13],M=r[14],w=r[15],t[12]=g*n+b*s+M*l+w*m,t[13]=g*i+b*u+M*c+w*y,t[14]=g*o+b*h+M*p+w*x,t[15]=g*a+b*f+M*d+w*v,t}function Rt(t,e,r){var n,i,o,a,s,u,h,f,l,c,p,d,m=r[0],y=r[1],x=r[2];return e===t?(t[12]=e[0]*m+e[4]*y+e[8]*x+e[12],t[13]=e[1]*m+e[5]*y+e[9]*x+e[13],t[14]=e[2]*m+e[6]*y+e[10]*x+e[14],t[15]=e[3]*m+e[7]*y+e[11]*x+e[15]):(n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],h=e[6],f=e[7],l=e[8],c=e[9],p=e[10],d=e[11],t[0]=n,t[1]=i,t[2]=o,t[3]=a,t[4]=s,t[5]=u,t[6]=h,t[7]=f,t[8]=l,t[9]=c,t[10]=p,t[11]=d,t[12]=n*m+s*y+l*x+e[12],t[13]=i*m+u*y+c*x+e[13],t[14]=o*m+h*y+p*x+e[14],t[15]=a*m+f*y+d*x+e[15]),t}function Pt(t,e,r){var n=r[0],i=r[1],o=r[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Ot(t,e,r,n){var i,o,a,s,u,h,f,l,c,p,d,m,y,x,v,g,b,M,w,T,_,S,E,A,R=n[0],P=n[1],O=n[2],F=Math.sqrt(R*R+P*P+O*O);return F<U?null:(R*=F=1/F,P*=F,O*=F,i=Math.sin(r),a=1-(o=Math.cos(r)),s=e[0],u=e[1],h=e[2],f=e[3],l=e[4],c=e[5],p=e[6],d=e[7],m=e[8],y=e[9],x=e[10],v=e[11],g=R*R*a+o,b=P*R*a+O*i,M=O*R*a-P*i,w=R*P*a-O*i,T=P*P*a+o,_=O*P*a+R*i,S=R*O*a+P*i,E=P*O*a-R*i,A=O*O*a+o,t[0]=s*g+l*b+m*M,t[1]=u*g+c*b+y*M,t[2]=h*g+p*b+x*M,t[3]=f*g+d*b+v*M,t[4]=s*w+l*T+m*_,t[5]=u*w+c*T+y*_,t[6]=h*w+p*T+x*_,t[7]=f*w+d*T+v*_,t[8]=s*S+l*E+m*A,t[9]=u*S+c*E+y*A,t[10]=h*S+p*E+x*A,t[11]=f*S+d*E+v*A,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}function Ft(t,e,r){var n=Math.sin(r),i=Math.cos(r),o=e[4],a=e[5],s=e[6],u=e[7],h=e[8],f=e[9],l=e[10],c=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*i+h*n,t[5]=a*i+f*n,t[6]=s*i+l*n,t[7]=u*i+c*n,t[8]=h*i-o*n,t[9]=f*i-a*n,t[10]=l*i-s*n,t[11]=c*i-u*n,t}function Bt(t,e,r){var n=Math.sin(r),i=Math.cos(r),o=e[0],a=e[1],s=e[2],u=e[3],h=e[8],f=e[9],l=e[10],c=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i-h*n,t[1]=a*i-f*n,t[2]=s*i-l*n,t[3]=u*i-c*n,t[8]=o*n+h*i,t[9]=a*n+f*i,t[10]=s*n+l*i,t[11]=u*n+c*i,t}function Lt(t,e,r){var n=Math.sin(r),i=Math.cos(r),o=e[0],a=e[1],s=e[2],u=e[3],h=e[4],f=e[5],l=e[6],c=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i+h*n,t[1]=a*i+f*n,t[2]=s*i+l*n,t[3]=u*i+c*n,t[4]=h*i-o*n,t[5]=f*i-a*n,t[6]=l*i-s*n,t[7]=c*i-u*n,t}function Ct(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}function Dt(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Ut(t,e,r){var n,i,o,a=r[0],s=r[1],u=r[2],h=Math.sqrt(a*a+s*s+u*u);return h<U?null:(a*=h=1/h,s*=h,u*=h,n=Math.sin(e),o=1-(i=Math.cos(e)),t[0]=a*a*o+i,t[1]=s*a*o+u*n,t[2]=u*a*o-s*n,t[3]=0,t[4]=a*s*o-u*n,t[5]=s*s*o+i,t[6]=u*s*o+a*n,t[7]=0,t[8]=a*u*o+s*n,t[9]=s*u*o-a*n,t[10]=u*u*o+i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)}function It(t,e){var r=Math.sin(e),n=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=r,t[7]=0,t[8]=0,t[9]=-r,t[10]=n,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function kt(t,e){var r=Math.sin(e),n=Math.cos(e);return t[0]=n,t[1]=0,t[2]=-r,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=r,t[9]=0,t[10]=n,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function zt(t,e){var r=Math.sin(e),n=Math.cos(e);return t[0]=n,t[1]=r,t[2]=0,t[3]=0,t[4]=-r,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function jt(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=n+n,u=i+i,h=o+o,f=n*s,l=n*u,c=n*h,p=i*u,d=i*h,m=o*h,y=a*s,x=a*u,v=a*h;return t[0]=1-(p+m),t[1]=l+v,t[2]=c-x,t[3]=0,t[4]=l-v,t[5]=1-(f+m),t[6]=d+y,t[7]=0,t[8]=c+x,t[9]=d-y,t[10]=1-(f+p),t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function Vt(t,e){var r=new I(3),n=-e[0],i=-e[1],o=-e[2],a=e[3],s=e[4],u=e[5],h=e[6],f=e[7],l=n*n+i*i+o*o+a*a;return l>0?(r[0]=2*(s*a+f*n+u*o-h*i)/l,r[1]=2*(u*a+f*i+h*n-s*o)/l,r[2]=2*(h*a+f*o+s*i-u*n)/l):(r[0]=2*(s*a+f*n+u*o-h*i),r[1]=2*(u*a+f*i+h*n-s*o),r[2]=2*(h*a+f*o+s*i-u*n)),jt(t,e,r),t}function Xt(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function Nt(t,e){var r=e[0],n=e[1],i=e[2],o=e[4],a=e[5],s=e[6],u=e[8],h=e[9],f=e[10];return t[0]=Math.sqrt(r*r+n*n+i*i),t[1]=Math.sqrt(o*o+a*a+s*s),t[2]=Math.sqrt(u*u+h*h+f*f),t}function Wt(t,e){var r=e[0]+e[5]+e[10],n=0;return r>0?(n=2*Math.sqrt(r+1),t[3]=.25*n,t[0]=(e[6]-e[9])/n,t[1]=(e[8]-e[2])/n,t[2]=(e[1]-e[4])/n):e[0]>e[5]&&e[0]>e[10]?(n=2*Math.sqrt(1+e[0]-e[5]-e[10]),t[3]=(e[6]-e[9])/n,t[0]=.25*n,t[1]=(e[1]+e[4])/n,t[2]=(e[8]+e[2])/n):e[5]>e[10]?(n=2*Math.sqrt(1+e[5]-e[0]-e[10]),t[3]=(e[8]-e[2])/n,t[0]=(e[1]+e[4])/n,t[1]=.25*n,t[2]=(e[6]+e[9])/n):(n=2*Math.sqrt(1+e[10]-e[0]-e[5]),t[3]=(e[1]-e[4])/n,t[0]=(e[8]+e[2])/n,t[1]=(e[6]+e[9])/n,t[2]=.25*n),t}function Yt(t,e,r,n){var i=e[0],o=e[1],a=e[2],s=e[3],u=i+i,h=o+o,f=a+a,l=i*u,c=i*h,p=i*f,d=o*h,m=o*f,y=a*f,x=s*u,v=s*h,g=s*f,b=n[0],M=n[1],w=n[2];return t[0]=(1-(d+y))*b,t[1]=(c+g)*b,t[2]=(p-v)*b,t[3]=0,t[4]=(c-g)*M,t[5]=(1-(l+y))*M,t[6]=(m+x)*M,t[7]=0,t[8]=(p+v)*w,t[9]=(m-x)*w,t[10]=(1-(l+d))*w,t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function qt(t,e,r,n,i){var o=e[0],a=e[1],s=e[2],u=e[3],h=o+o,f=a+a,l=s+s,c=o*h,p=o*f,d=o*l,m=a*f,y=a*l,x=s*l,v=u*h,g=u*f,b=u*l,M=n[0],w=n[1],T=n[2],_=i[0],S=i[1],E=i[2],A=(1-(m+x))*M,R=(p+b)*M,P=(d-g)*M,O=(p-b)*w,F=(1-(c+x))*w,B=(y+v)*w,L=(d+g)*T,C=(y-v)*T,D=(1-(c+m))*T;return t[0]=A,t[1]=R,t[2]=P,t[3]=0,t[4]=O,t[5]=F,t[6]=B,t[7]=0,t[8]=L,t[9]=C,t[10]=D,t[11]=0,t[12]=r[0]+_-(A*_+O*S+L*E),t[13]=r[1]+S-(R*_+F*S+C*E),t[14]=r[2]+E-(P*_+B*S+D*E),t[15]=1,t}function Ht(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=r+r,s=n+n,u=i+i,h=r*a,f=n*a,l=n*s,c=i*a,p=i*s,d=i*u,m=o*a,y=o*s,x=o*u;return t[0]=1-l-d,t[1]=f+x,t[2]=c-y,t[3]=0,t[4]=f-x,t[5]=1-h-d,t[6]=p+m,t[7]=0,t[8]=c+y,t[9]=p-m,t[10]=1-h-l,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function $t(t,e,r,n,i,o,a){var s=1/(r-e),u=1/(i-n),h=1/(o-a);return t[0]=2*o*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*o*u,t[6]=0,t[7]=0,t[8]=(r+e)*s,t[9]=(i+n)*u,t[10]=(a+o)*h,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*o*2*h,t[15]=0,t}function Gt(t,e,r,n,i){var o,a=1/Math.tan(e/2);return t[0]=a/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=i&&i!==1/0?(o=1/(n-i),t[10]=(i+n)*o,t[14]=2*i*n*o):(t[10]=-1,t[14]=-2*n),t}function Kt(t,e,r,n){var i=Math.tan(e.upDegrees*Math.PI/180),o=Math.tan(e.downDegrees*Math.PI/180),a=Math.tan(e.leftDegrees*Math.PI/180),s=Math.tan(e.rightDegrees*Math.PI/180),u=2/(a+s),h=2/(i+o);return t[0]=u,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=h,t[6]=0,t[7]=0,t[8]=-(a-s)*u*.5,t[9]=(i-o)*h*.5,t[10]=n/(r-n),t[11]=-1,t[12]=0,t[13]=0,t[14]=n*r/(r-n),t[15]=0,t}function Zt(t,e,r,n,i,o,a){var s=1/(e-r),u=1/(n-i),h=1/(o-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+r)*s,t[13]=(i+n)*u,t[14]=(a+o)*h,t[15]=1,t}function Jt(t,e,r,n){var i,o,a,s,u,h,f,l,c,p,d=e[0],m=e[1],y=e[2],x=n[0],v=n[1],g=n[2],b=r[0],M=r[1],w=r[2];return Math.abs(d-b)<U&&Math.abs(m-M)<U&&Math.abs(y-w)<U?wt(t):(f=d-b,l=m-M,c=y-w,i=v*(c*=p=1/Math.sqrt(f*f+l*l+c*c))-g*(l*=p),o=g*(f*=p)-x*c,a=x*l-v*f,(p=Math.sqrt(i*i+o*o+a*a))?(i*=p=1/p,o*=p,a*=p):(i=0,o=0,a=0),s=l*a-c*o,u=c*i-f*a,h=f*o-l*i,(p=Math.sqrt(s*s+u*u+h*h))?(s*=p=1/p,u*=p,h*=p):(s=0,u=0,h=0),t[0]=i,t[1]=s,t[2]=f,t[3]=0,t[4]=o,t[5]=u,t[6]=l,t[7]=0,t[8]=a,t[9]=h,t[10]=c,t[11]=0,t[12]=-(i*d+o*m+a*y),t[13]=-(s*d+u*m+h*y),t[14]=-(f*d+l*m+c*y),t[15]=1,t)}function Qt(t,e,r,n){var i=e[0],o=e[1],a=e[2],s=n[0],u=n[1],h=n[2],f=i-r[0],l=o-r[1],c=a-r[2],p=f*f+l*l+c*c;p>0&&(f*=p=1/Math.sqrt(p),l*=p,c*=p);var d=u*c-h*l,m=h*f-s*c,y=s*l-u*f;return(p=d*d+m*m+y*y)>0&&(d*=p=1/Math.sqrt(p),m*=p,y*=p),t[0]=d,t[1]=m,t[2]=y,t[3]=0,t[4]=l*y-c*m,t[5]=c*d-f*y,t[6]=f*m-l*d,t[7]=0,t[8]=f,t[9]=l,t[10]=c,t[11]=0,t[12]=i,t[13]=o,t[14]=a,t[15]=1,t}function te(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"}function ee(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))}function re(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t[8]=e[8]+r[8],t[9]=e[9]+r[9],t[10]=e[10]+r[10],t[11]=e[11]+r[11],t[12]=e[12]+r[12],t[13]=e[13]+r[13],t[14]=e[14]+r[14],t[15]=e[15]+r[15],t}function ne(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t[6]=e[6]-r[6],t[7]=e[7]-r[7],t[8]=e[8]-r[8],t[9]=e[9]-r[9],t[10]=e[10]-r[10],t[11]=e[11]-r[11],t[12]=e[12]-r[12],t[13]=e[13]-r[13],t[14]=e[14]-r[14],t[15]=e[15]-r[15],t}function ie(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*r,t[9]=e[9]*r,t[10]=e[10]*r,t[11]=e[11]*r,t[12]=e[12]*r,t[13]=e[13]*r,t[14]=e[14]*r,t[15]=e[15]*r,t}function oe(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t[3]=e[3]+r[3]*n,t[4]=e[4]+r[4]*n,t[5]=e[5]+r[5]*n,t[6]=e[6]+r[6]*n,t[7]=e[7]+r[7]*n,t[8]=e[8]+r[8]*n,t[9]=e[9]+r[9]*n,t[10]=e[10]+r[10]*n,t[11]=e[11]+r[11]*n,t[12]=e[12]+r[12]*n,t[13]=e[13]+r[13]*n,t[14]=e[14]+r[14]*n,t[15]=e[15]+r[15]*n,t}function ae(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function se(t,e){var r=t[0],n=t[1],i=t[2],o=t[3],a=t[4],s=t[5],u=t[6],h=t[7],f=t[8],l=t[9],c=t[10],p=t[11],d=t[12],m=t[13],y=t[14],x=t[15],v=e[0],g=e[1],b=e[2],M=e[3],w=e[4],T=e[5],_=e[6],S=e[7],E=e[8],A=e[9],R=e[10],P=e[11],O=e[12],F=e[13],B=e[14],L=e[15];return Math.abs(r-v)<=U*Math.max(1,Math.abs(r),Math.abs(v))&&Math.abs(n-g)<=U*Math.max(1,Math.abs(n),Math.abs(g))&&Math.abs(i-b)<=U*Math.max(1,Math.abs(i),Math.abs(b))&&Math.abs(o-M)<=U*Math.max(1,Math.abs(o),Math.abs(M))&&Math.abs(a-w)<=U*Math.max(1,Math.abs(a),Math.abs(w))&&Math.abs(s-T)<=U*Math.max(1,Math.abs(s),Math.abs(T))&&Math.abs(u-_)<=U*Math.max(1,Math.abs(u),Math.abs(_))&&Math.abs(h-S)<=U*Math.max(1,Math.abs(h),Math.abs(S))&&Math.abs(f-E)<=U*Math.max(1,Math.abs(f),Math.abs(E))&&Math.abs(l-A)<=U*Math.max(1,Math.abs(l),Math.abs(A))&&Math.abs(c-R)<=U*Math.max(1,Math.abs(c),Math.abs(R))&&Math.abs(p-P)<=U*Math.max(1,Math.abs(p),Math.abs(P))&&Math.abs(d-O)<=U*Math.max(1,Math.abs(d),Math.abs(O))&&Math.abs(m-F)<=U*Math.max(1,Math.abs(m),Math.abs(F))&&Math.abs(y-B)<=U*Math.max(1,Math.abs(y),Math.abs(B))&&Math.abs(x-L)<=U*Math.max(1,Math.abs(x),Math.abs(L))}var ue=At,he=ne;function fe(){var t=new I(2);return I!=Float32Array&&(t[0]=0,t[1]=0),t}function le(t){var e=new I(2);return e[0]=t[0],e[1]=t[1],e}function ce(t,e){var r=new I(2);return r[0]=t,r[1]=e,r}function pe(t,e){return t[0]=e[0],t[1]=e[1],t}function de(t,e,r){return t[0]=e,t[1]=r,t}function me(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t}function ye(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t}function xe(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t}function ve(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t}function ge(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t}function be(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t}function Me(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t}function we(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t}function Te(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t}function _e(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t}function Se(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t}function Ee(t,e){var r=e[0]-t[0],n=e[1]-t[1];return Math.sqrt(r*r+n*n)}function Ae(t,e){var r=e[0]-t[0],n=e[1]-t[1];return r*r+n*n}function Re(t){var e=t[0],r=t[1];return Math.sqrt(e*e+r*r)}function Pe(t){var e=t[0],r=t[1];return e*e+r*r}function Oe(t,e){return t[0]=-e[0],t[1]=-e[1],t}function Fe(t,e){return t[0]=1/e[0],t[1]=1/e[1],t}function Be(t,e){var r=e[0],n=e[1],i=r*r+n*n;return i>0&&(i=1/Math.sqrt(i)),t[0]=e[0]*i,t[1]=e[1]*i,t}function Le(t,e){return t[0]*e[0]+t[1]*e[1]}function Ce(t,e,r){var n=e[0]*r[1]-e[1]*r[0];return t[0]=t[1]=0,t[2]=n,t}function De(t,e,r,n){var i=e[0],o=e[1];return t[0]=i+n*(r[0]-i),t[1]=o+n*(r[1]-o),t}function Ue(t,e){e=e||1;var r=2*k()*Math.PI;return t[0]=Math.cos(r)*e,t[1]=Math.sin(r)*e,t}function Ie(t,e,r){var n=e[0],i=e[1];return t[0]=r[0]*n+r[2]*i,t[1]=r[1]*n+r[3]*i,t}function ke(t,e,r){var n=e[0],i=e[1];return t[0]=r[0]*n+r[2]*i+r[4],t[1]=r[1]*n+r[3]*i+r[5],t}function ze(t,e,r){var n=e[0],i=e[1];return t[0]=r[0]*n+r[3]*i+r[6],t[1]=r[1]*n+r[4]*i+r[7],t}function je(t,e,r){var n=e[0],i=e[1];return t[0]=r[0]*n+r[4]*i+r[12],t[1]=r[1]*n+r[5]*i+r[13],t}function Ve(t,e,r,n){var i=e[0]-r[0],o=e[1]-r[1],a=Math.sin(n),s=Math.cos(n);return t[0]=i*s-o*a+r[0],t[1]=i*a+o*s+r[1],t}function Xe(t,e){var r=t[0],n=t[1],i=e[0],o=e[1],a=r*r+n*n;a>0&&(a=1/Math.sqrt(a));var s=i*i+o*o;s>0&&(s=1/Math.sqrt(s));var u=(r*i+n*o)*a*s;return u>1?0:u<-1?Math.PI:Math.acos(u)}function Ne(t){return t[0]=0,t[1]=0,t}function We(t){return"vec2("+t[0]+", "+t[1]+")"}function Ye(t,e){return t[0]===e[0]&&t[1]===e[1]}function qe(t,e){var r=t[0],n=t[1],i=e[0],o=e[1];return Math.abs(r-i)<=U*Math.max(1,Math.abs(r),Math.abs(i))&&Math.abs(n-o)<=U*Math.max(1,Math.abs(n),Math.abs(o))}var He,$e=Re,Ge=ye,Ke=xe,Ze=ve,Je=Ee,Qe=Ae,tr=Pe,er=(He=fe(),function(t,e,r,n,i,o){var a,s;for(e||(e=2),r||(r=0),s=n?Math.min(n*e+r,t.length):t.length,a=r;a<s;a+=e)He[0]=t[a],He[1]=t[a+1],i(He,He,o),t[a]=He[0],t[a+1]=He[1];return t});r.d(e,"a",function(){return ar}),r.d(e,"b",function(){return hr}),r.d(e,"c",function(){return mr});var rr,nr,ir,or,ar=!0,sr=32,ur=512,hr=16,fr=function(){function t(t,e,r,n){this.effect=t,this.operation=e,this.blendSrc=r,this.blendDst=n}return t.prototype.apply=function(t){var e=t.S,r=this.effect,n=this.blendSrc,i=this.blendDst,o=this.operation;if(x.p[0]=x.p[1]=x.p[2]=x.p[3]=1,e.blendEquation("sub"===o?e.FUNC_REVERSE_SUBTRACT:e.FUNC_ADD),"blend"===r)e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);else if("premult"===r)e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA);else if("color"===r){var a=C.a.extract(i,t.N),s=C.a.extract(n,t.N);e.blendColor(a.r/255,a.g/255,a.b/255,a.a/255),x.p[0]=s.r/255,x.p[1]=s.g/255,x.p[2]=s.b/255,x.p[3]=s.a/255,e.blendFunc(e.SRC_ALPHA,e.CONSTANT_COLOR),e.enable(e.BLEND)}else e.disable(e.BLEND)},t}(),lr=new fr("none","add",0,0),cr=new fr("blend","add",0,0);!function(t){t[t.current=0]="current",t[t.rom=1]="rom",t[t.blank=2]="blank"}(or||(or={}));var pr=function(){function t(){this.V=-1,this.length=x.i,this.buffer=new Float32Array(8*this.length)}return t.prototype.getLine=function(t){if(t<0||t>=this.length)throw new Error("getLine: index "+t+" out of range");return n.fromValues(this.buffer[8*t],this.buffer[8*t+1],this.buffer[8*t+2],this.buffer[8*t+3],this.buffer[8*t+4],this.buffer[8*t+5],this.buffer[8*t+6],this.buffer[8*t+7],1)},t.prototype.setAll=function(t){var e=n.create();this.V=-1;for(var r=0;r<this.length;r++)n.translate(e,t,[0,r]),this.setLine(r,e)},t.prototype.setLine=function(t,e){if(t<0||t>=this.length)throw new Error("setLine: index "+t+" out of range");this.V=-1,this.buffer.set(e.subarray(0,8),8*t)},t}(),dr=function(){function t(t,e){this.targetPaletteNumber=e,this.targetPaletteIndex=t,this.length=x.i,this.buffer=new Float32Array(4*this.length)}return t.prototype.setAll=function(t,e){for(var r=0;r<this.length;r++)this.setLine(r,t,e)},t.prototype.setLine=function(t,e,r){if(t<0||t>=this.length)throw new Error("setLine: index "+t+" out of range");this.buffer[4*t]=Math.floor(e%256)/x.h,this.buffer[4*t+1]=Math.floor(r%256)/x.g},t}(),mr=function(){function t(t,e,r){var i=this;this.W=0,this.X=new fr("color","add",8947848,8947848),this.G=new fr("color","add",8947848,8947848),this.K=R("Opaque BG [BG]",sr),this.Y=R("Transparent BG [TBG]",1),this.H=_("Opaque sprites [OBJ0]",ur),this.J=_("Transparent sprites [OBJ1]",ur),this.Z={peakOBJ:0,peakBG:0,peakVramWrites:0},this.$=!0,this.tt=0,this.nt=0,this.rt=0,this.et=0,this.LineColorArray=dr,this.LineTransformationArray=pr,this.CopySource=or,this.color=C.a,this.mat3=n,this.vec2=o,this.it(t),this.ot();var s=this.S;window.fetch("build/game.json").then(function(t){if(!t.ok)throw new Error("You need to build your project first; run `npm run convert-gfx`.");return t.json()}).then(function(t){if(i.at=t,i.N=t.info.paletteBpp,-1===[2,3,4,5,8].indexOf(i.N))throw new Error("Unsupported paletteBpp "+i.N);Promise.all([l(s,"build/sprites.png").then(function(t){var e,r;i.O=t.texture,i.ut=(e=t,r=new Uint8Array(d(s,e.texture,0,0,e.width,e.height).buffer),new D(r,e.width,e.height,4)),i.ft=i.ut.clone(),Object(x.u)(t.width,t.height)}),l(s,"build/palettes.png").then(function(t){if(!(256===t.width&&64===t.height||16===t.width&&256===t.height))throw new Error("Mismatch in texture size (max {16,256}x256");var e,r;i.C=t.texture,i.ct=(e=t,r=new Uint32Array(d(s,e.texture,0,0,e.width,e.height).buffer),new D(r,e.width,e.height,1)),i.ht=i.ct.clone(),8!==i.N&&i.ht.setPosterization(i.N),Object(x.s)(t.width,t.height)}),l(s,"build/maps.png").then(function(t){var e,r;i.F=t.texture,i.st=(e=t,r=new Uint16Array(d(s,e.texture,0,0,e.width,e.height).buffer),new D(r,e.width,e.height,2)),i.lt=i.st.clone(),Object(x.r)(t.width,t.height)})]).then(function(){i.T=function(t,e,r){a||(a=t.getExtension("OES_texture_float"));var n=t.createTexture(),i=new Float32Array(e*r*4);return i.fill(0),t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,r,0,t.RGBA,t.FLOAT,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),n}(s,x.e,x.d),i.configBackdropColor("#008"),i.configDisplay({extraSprites:!1}),function(t){var e=t.S,r=f(e,"attribute vec4 aXyzp;\nattribute vec4 aMapInfo1;\nattribute vec4 aMapInfo2;\nattribute vec4 aMapInfo3;\nattribute vec4 aMapInfo4;\nuniform mat3 uModelViewMatrix;\nuniform mat4 uProjectionMatrix;\n\nvarying vec2 vTextureCoord;\nvarying float vPaletteNo;\n// TODO Florian -- use vec4 and extract in fragment program\nvarying highp vec2 vMapStart;\nvarying highp vec2 vMapSize;\nvarying vec2 vTilesetStart;\nvarying float vTilesetWidth;\nvarying vec2 vTileSize;\nvarying mat3 vTransformationMatrix;\n// [0] = linescroll buffer, if 0 use vTransformationMatrix always, [1] = whether to wrap around\nvarying vec2 vOtherInfo;\n\nuniform sampler2D uSamplerMaps, uSamplerSprites, uSamplerPalettes, uSamplerOthers;\n\nmat3 readLinescrollBuffer(int bufferNo, int horizOffset) {\n\tfloat vOfs = float(bufferNo) / "+x.d+".0;\n\tvec4 first = texture2D(uSamplerOthers, vec2(float(horizOffset) / "+x.e+".0, vOfs));\n\tvec4 second = texture2D(uSamplerOthers, vec2(float(horizOffset + 1) / "+x.e+".0, vOfs));\n\treturn mat3(\n\t\tfirst.xy, 0,\n\t\tvec2(first.a, second.r), 0,\n\t\tsecond.ba, 1.0);\n}\n\nvoid main(void) {\n\t// Only scale the final matrix (we can always say that the VDP supports fixed point math inside for matrix multiplication)\n\tgl_Position = uProjectionMatrix * vec4(floor(uModelViewMatrix * aXyzp.xyz), 1);\n\tvPaletteNo = floor(aXyzp.w);\n\tvMapStart = floor(aMapInfo1.xy);\n\tvTilesetStart = floor(aMapInfo1.zw);\n\tvMapSize = floor(aMapInfo2.xy);\n\tvTilesetWidth = floor(aMapInfo2.z);\n\tvTileSize = floor(aMapInfo3.xy);\n\tvTextureCoord = floor(aMapInfo3.zw);\n\tvOtherInfo = floor(aMapInfo4.xy);\n\t// If 0-255, use one transformation map-wide from the first line, if -1 never use transformations\n\tif (aMapInfo4.x >= 0.0 && aMapInfo4.x < 256.0) {\n\t\tvTransformationMatrix = readLinescrollBuffer(0, int(aMapInfo4.x) * 2);\n\t} else {\n\t\tvTransformationMatrix = mat3(\n\t\t\t1, 0, 0,\n\t\t\t0, 1, 0,\n\t\t\t0, 0, 1);\n\t}\n}\n","precision highp float;\n\nvarying highp vec2 vTextureCoord;\nvarying highp float vPaletteNo;\nvarying highp vec2 vMapStart;\nvarying highp vec2 vMapSize;varying vec2 vTilesetStart;\nvarying float vTilesetWidth;\nvarying vec2 vTileSize;\nvarying mat3 vTransformationMatrix;\nvarying vec2 vOtherInfo;\n\nuniform mat3 uModelViewMatrix;\nuniform vec4 uEnvColor, uColorSwaps;\nuniform sampler2D uSamplerMaps, uSamplerSprites, uSamplerPalettes, uSamplerOthers;\n\nint intDiv(float x, float y) {\n\treturn int(floor(x / y));\n}float modI(float a,float b) {\n\tfloat m=a-floor((a+0.5)/b)*b;\n\treturn floor(m+0.5);\n}\n\nmat3 readLinescrollBuffer(int bufferNo, int horizOffset) {\n\tfloat vOfs = float(bufferNo) / "+x.d+".0;\n\tvec4 first = texture2D(uSamplerOthers, vec2(float(horizOffset) / "+x.e+".0, vOfs));\n\tvec4 second = texture2D(uSamplerOthers, vec2(float(horizOffset + 1) / "+x.e+".0, vOfs));\n\treturn mat3(\n\t\tfirst.r, first.g, 0,\n\t\tfirst.a, second.r, 0,\n\t\tsecond.b, second.a, 1);\n}\n\nint readMap(int x, int y) {\n\tx = int(modI(float(x), vMapSize.x) + vMapStart.x);\n\ty = int(modI(float(y), vMapSize.y) + vMapStart.y);\n\n\tint texelId = x / 2;\n\tint texelC = x - texelId * 2;\n\tvec4 read = texture2D(uSamplerMaps, vec2(float(texelId) / "+x.b+".0, float(y) / "+x.a+".0));\n\tif (texelC == 0) return int(read.r * 255.0) + int(read.g * 255.0) * 256;\n\treturn int(read.b * 255.0) + int(read.a * 255.0) * 256;\n}\n\nvec2 positionInTexture(int tileNo) {\n\tvec2 base = vTilesetStart;\n\tfloat rowNo = float(tileNo / int(vTilesetWidth));\n\tfloat colNo = modI(float(tileNo), vTilesetWidth);\n\treturn base + vec2(colNo * vTileSize.x, rowNo * vTileSize.y);\n}\n\n"+Object(x.o)()+"\n"+Object(x.n)()+"\n\nvoid main(void) {\n\tmat3 transformationMatrix;\n\tfloat y = vTextureCoord.y;\n\t// Per-line info\n\tif (vOtherInfo.x >= 256.0) {\t\ttransformationMatrix = readLinescrollBuffer(int(vOtherInfo.x) - 256, int(y) * 2);\n\t\ty = 0.0;\n\t}\n\telse {\n\t\ttransformationMatrix = vTransformationMatrix;\n\t}\n\n\tvec2 texCoord = floor((transformationMatrix * vec3(vTextureCoord.x, y, 1)).xy);\tif (vOtherInfo.y < 1.0) {\n\t\tif (texCoord.x < 0.0) texCoord.x = 0.0;\n\t\tif (texCoord.y < 0.0) texCoord.y = 0.0;\n\t\tif (texCoord.x >= vTileSize.x * vMapSize.x) texCoord.x = vTileSize.x * vMapSize.x - 1.0;\n\t\tif (texCoord.y >= vTileSize.y * vMapSize.y) texCoord.y = vTileSize.y * vMapSize.y - 1.0;\n\t}\n\n\tint mapX = intDiv(texCoord.x, vTileSize.x), mapY = intDiv(texCoord.y, vTileSize.y);\n\tfloat basePalette = vPaletteNo;\n\tif (vPaletteNo >= "+x.f+".0) {\n\t\tbasePalette -= "+x.f+".0;\n\t}\tint mapTileNo = readMap(mapX, mapY);\tif (mapTileNo >= 65535) {\n\t\tvec4 color = readPalette(0.0, basePalette / "+x.g+".0);\n\t\tgl_FragColor = "+Object(x.q)("color")+";\n\t\treturn;\n\t}\tint palOfs = mapTileNo / 8192;\n\tfloat paletteOffset = basePalette + float(palOfs);\n\tmapTileNo -= palOfs * 8192;\tvec2 offsetInTile = vec2(int(texCoord.x) - mapX * int(vTileSize.x), int(texCoord.y) - mapY * int(vTileSize.y));\n\tvec2 tilesetPos = positionInTexture(mapTileNo) + offsetInTile;\n\tfloat texel;\n\n\tif (vPaletteNo >= "+x.f+".0) {\n\t\ttexel = readTexel8(tilesetPos.x, tilesetPos.y);\n\t}\n\telse {\n\t\ttexel = readTexel4(tilesetPos.x, tilesetPos.y);\n\t}\n\n\tvec4 color = readPalette(texel, paletteOffset / "+x.g+".0);\n\tgl_FragColor = "+Object(x.q)("color")+";\n}");t.D={program:r,attribLocations:{xyzp:e.getAttribLocation(r,"aXyzp"),mapInfo1:e.getAttribLocation(r,"aMapInfo1"),mapInfo2:e.getAttribLocation(r,"aMapInfo2"),mapInfo3:e.getAttribLocation(r,"aMapInfo3"),mapInfo4:e.getAttribLocation(r,"aMapInfo4")},glBuffers:{xyzp:c(e),mapInfo1:c(e),mapInfo2:c(e),mapInfo3:c(e),mapInfo4:c(e)},uniformLocations:{colorSwaps:e.getUniformLocation(r,"uColorSwaps"),envColor:e.getUniformLocation(r,"uEnvColor"),projectionMatrix:e.getUniformLocation(r,"uProjectionMatrix"),modelViewMatrix:e.getUniformLocation(r,"uModelViewMatrix"),uSamplerMaps:e.getUniformLocation(r,"uSamplerMaps"),uSamplerSprites:e.getUniformLocation(r,"uSamplerSprites"),uSamplerPalettes:e.getUniformLocation(r,"uSamplerPalettes"),uSamplerOthers:e.getUniformLocation(r,"uSamplerOthers")}}}(i),function(t){var e=t.S,r=f(e,"// The 3 first are the vertex position, the 4th is the palette ID\nattribute vec4 aXyzp;\n// The 2 first are the texture position\nattribute vec2 aUv;\n\nuniform mat3 uModelViewMatrix;\nuniform mat4 uProjectionMatrix;\n\nvarying highp vec2 vTextureCoord;\nvarying highp float vPaletteNo;\nuniform sampler2D uSamplerSprites, uSamplerPalettes;\n\nvoid main(void) {\n\t// Only scale the final matrix (we can always say that the VDP supports fixed point math inside for matrix multiplication)\n\tgl_Position = uProjectionMatrix * vec4(floor(uModelViewMatrix * vec3(aXyzp.xy, aXyzp.z)), 1);\n\tvPaletteNo = aXyzp.w;\n\tvTextureCoord = aUv;\n}","precision highp float;\n\nvarying highp vec2 vTextureCoord;\nvarying highp float vPaletteNo;\nuniform vec4 uEnvColor, uColorSwaps;\nuniform sampler2D uSamplerOthers, uSamplerSprites, uSamplerPalettes;\n\n"+Object(x.o)()+"\n"+Object(x.n)()+"\n\nvoid main(void) {\n\tfloat texel, palette;\n\tif (vPaletteNo >= "+x.f+".0) {\n\t\ttexel = readTexel8(vTextureCoord.x, vTextureCoord.y);\n\t\tpalette = (vPaletteNo - "+x.f+".0) / "+x.g+".0;\n\t}\n\telse {\n\t\ttexel = readTexel4(vTextureCoord.x, vTextureCoord.y);\n\t\tpalette = vPaletteNo / "+x.g+".0;\n\t}\n\n\tvec4 color = readPalette(texel, palette);\n\tgl_FragColor = "+Object(x.q)("color")+";\n}");t._={program:r,attribLocations:{xyzp:e.getAttribLocation(r,"aXyzp"),uv:e.getAttribLocation(r,"aUv")},glBuffers:{xyzp:c(e),uv:c(e)},uniformLocations:{colorSwaps:e.getUniformLocation(r,"uColorSwaps"),envColor:e.getUniformLocation(r,"uEnvColor"),projectionMatrix:e.getUniformLocation(r,"uProjectionMatrix"),modelViewMatrix:e.getUniformLocation(r,"uModelViewMatrix"),uSamplerOthers:e.getUniformLocation(r,"uSamplerOthers"),uSamplerSprites:e.getUniformLocation(r,"uSamplerSprites"),uSamplerPalettes:e.getUniformLocation(r,"uSamplerPalettes")}}}(i),function(t){var e=t.S,r=f(e,"\n\t\t\tattribute vec2 aXy;\n\t\t\tattribute vec4 aColor;\n\t\n\t\t\tuniform mat3 uModelViewMatrix;\n\t\t\tuniform mat4 uProjectionMatrix;\n\t\n\t\t\tvarying lowp vec4 vColor;\n\t\t\n\t\t\tvoid main(void) {\n\t\t\t\tvec4 pos = uProjectionMatrix * vec4(floor(uModelViewMatrix * vec3(aXy, 0)), 1);\n\t\t\t\tpos.z = 0.0;\n\t\t\t\tgl_Position = pos;\n\t\t\t\tvColor = aColor;\n\t\t\t}\n\t\t","precision highp float;\n    varying vec4 vColor;\n\t\tuniform vec4 uColorSwaps;\n\t\tuniform sampler2D uSamplerOthers, uSamplerPalettes;\n    \n    "+Object(x.n)(!1)+"\n\n    void main(void) {\n      if (vColor.a > 0.0) {\n\t      gl_FragColor = vColor;\n\t    } else {\n\t\t    vec4 color = readPalette(0.0, 0.0);\n\t\t\t\tgl_FragColor = vec4(color.rgb, 1.0);\n\t\t\t}\n    }\n  ");t.U={program:r,arrayBuffers:{xy:new Float32Array(8),color:new Float32Array(16)},attribLocations:{xy:e.getAttribLocation(r,"aXy"),color:e.getAttribLocation(r,"aColor")},glBuffers:{xy:c(e),color:c(e)},uniformLocations:{colorSwaps:e.getUniformLocation(r,"uColorSwaps"),projectionMatrix:e.getUniformLocation(r,"uProjectionMatrix"),modelViewMatrix:e.getUniformLocation(r,"uModelViewMatrix"),uSamplerOthers:e.getUniformLocation(r,"uSamplerOthers"),uSamplerPalettes:e.getUniformLocation(r,"uSamplerPalettes")}}}(i),r()})})}return t.prototype.configBackdropColor=function(t){var e=this.readPaletteMemory(0,0,1,1,or.blank);e.array[0]=C.a.make(t),this.writePaletteMemory(0,0,1,1,e)},t.prototype.configBackgroundTransparency=function(t){if("add"!==t.op&&"sub"!==t.op)throw new Error("Invalid operation "+t.op);this.X.operation=t.op,this.X.blendSrc=C.a.make(t.blendSrc),this.X.blendDst=C.a.make(t.blendDst)},t.prototype.configColorSwap=function(t){var e=this;if(t.length>4)throw new Error("Can only swap up to 4 colors at a time");t.forEach(function(t,r){x.m[r]=t.targetPaletteNumber<<8|t.targetPaletteIndex,m(e.S,e.T,0,r+x.c,t.buffer.length/4,1,t.buffer)});for(var r=t.length;r<4;r++)x.m[r]=-1},t.prototype.configDisplay=function(t){if(void 0===t&&(t={}),this.rt>0||this.nt>0)throw new Error("configDisplay must come at the beginning of your program/frame");rr=(t.extraSprites?1:2)*this.screenWidth*this.screenHeight,ir=t.extraSprites?512:256,nr=(t.extraSprites?2:1)*Math.ceil(this.screenWidth*this.screenHeight/(hr*hr))},t.prototype.configFade=function(t){var e=t.color||0;t.factor=Math.min(255,Math.max(0,t.factor)),this.W=16777215&C.a.make(e)|t.factor<<24},t.prototype.configObjectTransparency=function(t){if("add"!==t.op&&"sub"!==t.op)throw new Error("Invalid operation "+t.op);this.G.operation=t.op,this.G.blendSrc=C.a.make(t.blendSrc),this.G.blendDst=C.a.make(t.blendDst)},t.prototype.drawBackgroundTilemap=function(t,e){void 0===e&&(e={}),"string"==typeof t&&(t=this.map(t));var r=this.vt(e.hasOwnProperty("palette")?e.palette:t.designPalette),n=this.Mt(e.hasOwnProperty("tileset")?e.tileset:t.designTileset),i=e.hasOwnProperty("scrollX")?e.scrollX:0,o=e.hasOwnProperty("scrollY")?e.scrollY:0,a=e.hasOwnProperty("winX")?e.winX:0,s=e.hasOwnProperty("winY")?e.winY:0,u=e.hasOwnProperty("winW")?e.winW:x.j-a,h=e.hasOwnProperty("winH")?e.winH:x.i-s,f=!e.hasOwnProperty("wrap")||e.wrap,l=!!e.transparent,c=Math.floor(e.prio||(l?1:0)),p=l?this.Y:this.K;if(c<0||c>15)throw new Error("Unsupported BG priority (0-15)");var d=M(a,s,a+u,s+h);if(d+this.nt>rr)return ar&&console.log("Using too many BG pixels"),void(this.nt=rr);this.nt+=d;var v=-1;if(e.lineTransform&&(v=e.lineTransform.V)<0){if(this.tt>=2)return void(ar&&console.log("Only 2 LineTransformationArray are allowed"));e.lineTransform.V=v=256+this.tt,m(this.S,this.T,0,this.tt++,e.lineTransform.buffer.length/4,1,e.lineTransform.buffer)}!function(t,e,r,n,i,o,a,s,u,h,f,l,c,p,d,m,v,g,b,M,w){if(void 0===b&&(b=-1),void 0===M&&(M=1),void 0===w&&(w=0),d+=f,m+=l,s=Math.floor(s/u),g&&(v|=x.f),t.usedVertices>=t.maxVertices)ar&&console.log(t.name+" overuse (max "+t.maxVertices/S+"), ignoring drawBackgroundTilemap");else{t.usedVertices+=S;var T=t.firstVertice;t.xyzp.set(y([f,l,w,v,f+c,l,w,v,f,l+p,w,v,f+c,l+p,w,v],4),4*T),t.mapInfo1.set(y([e,r,n,i,e,r,n,i,e,r,n,i,e,r,n,i],4),4*T),t.mapInfo2.set(y([o,a,s,0,o,a,s,0,o,a,s,0,o,a,s,0],4),4*T),t.mapInfo3.set(y([u,h,d,m,u,h,d+c,m,u,h,d,m+p,u,h,d+c,m+p],4),4*T),t.mapInfo4.set(y([b,M,0,0,b,M,0,0,b,M,0,0,b,M,0,0],4),4*T)}}(p,t.x,t.y,n.x,n.y,t.w,t.h,n.w,n.tw,n.th,a,s,u,h,i,o,r.y,n.hiColor,v,f?1:0,c)},t.prototype.drawObject=function(t,e,r,n){void 0===n&&(n={}),"string"==typeof t&&(t=this.sprite(t));var i=this.vt(n.hasOwnProperty("palette")?n.palette:t.designPalette),o=n.hasOwnProperty("width")?n.width:t.w,a=n.hasOwnProperty("height")?n.height:t.h,s=Math.floor(n.prio||(n.transparent?2:1)),u=n.transparent?this.J:this.H,h=Math.floor(t.x),f=Math.floor(t.y);if(s<0||s>15)throw new Error("Unsupported object priority (0-15)");if(this.H.usedSprites+this.J.usedSprites>=ir)ar&&console.log("Using too many objects (max "+ir);else{var l=M(e,r,e+o,r+a,!0);if(l+this.rt>nr){if(ar&&console.log("Using too many OBJ pixels"),this.rt>=nr)return;var c=M(0,r,hr,r+a,!0),p=nr-this.rt,d=Math.floor(p/c)*hr;return T(u,e,r,e+d,r+a,h,f,h+t.w*d/o,f+Math.floor(t.h),i.y,t.hiColor,s,n.flipH,n.flipV),void(this.rt=nr)}this.rt+=l,T(u,e,r,e+o,r+a,h,f,h+Math.floor(t.w),f+Math.floor(t.h),i.y,t.hiColor,s,n.flipH,n.flipV)}},t.prototype.map=function(t){var e=this.at.maps[t];if(!e)throw new Error("Map "+t+" not found");return new O(e.x,e.y,e.w,e.h,e.til,e.pal)},t.prototype.palette=function(t){var e=this.at.pals[t];if(!e)throw new Error("Palette "+t+" not found");return new F(e.y,e.w,e.h)},t.prototype.readMap=function(t,e){void 0===e&&(e=or.current);var r=this.pt(t),n=new Uint16Array(r.w*r.h);return e===or.current&&this.lt.readToBuffer(r.x,r.y,r.w,r.h,n),e===or.rom&&this.st.readToBuffer(r.x,r.y,r.w,r.h,n),new L(n,r.w,r.h)},t.prototype.readPalette=function(t,e){void 0===e&&(e=or.current);var r=this.vt(t);return this.readPaletteMemory(0,r.y,r.w,r.h,e)},t.prototype.readPaletteMemory=function(t,e,r,n,i){void 0===i&&(i=or.current);var o=new Uint32Array(r*n);return i===or.current&&this.ht.readToBuffer(t,e,r,n,o),i===or.rom&&this.ct.readToBuffer(t,e,r,n,o),new L(o,r,n)},t.prototype.readSprite=function(t,e){void 0===e&&(e=or.current);var r=this.Mt(t);if(!r.hiColor&&r.x%2!=0)throw new Error("Lo-color sprites need to be aligned to 2 pixels");var n=r.hiColor?r.x:r.x/2,i=r.hiColor?r.w:Math.ceil(r.w/2),o=new Uint8Array(i*r.h);return e===or.current&&this.ft.readToBuffer(n,r.y,i,r.h,o),e===or.rom&&this.ut.readToBuffer(n,r.y,i,r.h,o),new L(o,i,r.h)},Object.defineProperty(t.prototype,"screenHeight",{get:function(){return x.i},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"screenWidth",{get:function(){return x.j},enumerable:!0,configurable:!0}),t.prototype.sprite=function(t){var e=this.at.sprites[t];if(!e)throw new Error("Sprite "+t+" not found");return new B(e.x,e.y,e.w,e.h,e.tw,e.th,e.tiles,e.hicol,e.pal)},t.prototype.writeMap=function(t,e){var r=this.pt(t);this.lt.writeTo(r.x,r.y,r.w,r.h,e.array),this.lt.syncToVramTexture(this.S,this.F,r.x,r.y,r.w,r.h),this.et+=r.w*r.h},t.prototype.writePalette=function(t,e){var r=this.vt(t);this.writePaletteMemory(0,r.y,r.w,r.h,e)},t.prototype.writePaletteMemory=function(t,e,r,n,i){this.ht.writeTo(t,e,r,n,i.array),this.ht.syncToVramTexture(this.S,this.C,t,e,r,n),this.et+=r*n},t.prototype.writeSprite=function(t,e){var r=this.Mt(t);if(!r.hiColor&&r.x%2!=0)throw new Error("Lo-color sprites need to be aligned to 2 pixels");var n=r.hiColor?r.x:r.x/2,i=r.hiColor?r.w:Math.ceil(r.w/2);this.ft.writeTo(n,r.y,i,r.h,e.array),this.ft.syncToVramTexture(this.S,this.O,n,r.y,i,r.h),this.et+=i*r.h},t.prototype.dt=function(){this.Z.peakBG=Math.max(this.Z.peakBG,this.nt/(this.screenWidth*this.screenHeight)),this.Z.peakOBJ=Math.max(this.Z.peakOBJ,this.rt)},t.prototype.xt=function(){var t=this.S;ar&&this.dt(),this.$&&(t.clearColor(0,0,0,0),x.l?(t.clearDepth(1),t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT)):t.clear(t.COLOR_BUFFER_BIT),t.disable(t.DEPTH_TEST),P(this,0,0,x.j,x.i,0,0,0,0),this.$=!1,x.l&&(t.depthFunc(t.LESS),t.enable(t.DEPTH_TEST))),lr.apply(this),A(this,this.K),w(this,this.H,0,this.H.usedSprites);var e=this.J.sort(this.Y.getZOfBG(0));this.G.apply(this),w(this,this.J,0,e),this.X.apply(this),A(this,this.Y),this.G.apply(this),w(this,this.J,e,this.J.usedSprites),this.tt=this.rt=this.nt=0},t.prototype.wt=function(){this.xt();var t=C.a.extract(this.W,this.N),e=t.r,r=t.g,n=t.b,i=t.a;if(i>0){var o=this.S;cr.apply(this),o.disable(o.DEPTH_TEST),P(this,0,0,x.j,x.i,e/255,r/255,n/255,i/255)}var a=Math.min(30,Math.ceil(this.et/2048));return ar&&a>1&&console.log("Overuse of VRAM writes for this frame ("+this.et+"/2048), slowing down "+a+"x"),this.Z.peakVramWrites=Math.max(this.Z.peakVramWrites,this.et),this.et=0,a},t.prototype.pt=function(t){return"string"==typeof t?this.map(t):t},t.prototype.vt=function(t){return"string"==typeof t?this.palette(t):t},t.prototype.Mt=function(t){return"string"==typeof t?this.sprite(t):t},t.prototype.yt=function(){var t=this.Z;return this.Z={peakOBJ:0,peakBG:0,peakVramWrites:0},t},t.prototype.it=function(t){this.S=t.getContext("webgl",{premultipliedAlpha:!0,alpha:x.k,antialias:!1}),null===this.S&&alert("Unable to initialize WebGL. Your browser or machine may not support it.")},t.prototype.ot=function(){this.P=i.create(),i.ortho(this.P,0,x.j,x.i,0,-16,16),this.I=n.create()},t.prototype._t=function(){this.$=!0},t}()},function(t,e,r){"use strict";var n,i,o=r(0),a=r(2),s=59.94,u=1/(s+1),h=1/s,f=1/(s-1),l=30,c=function(){function t(){this.last=0,this.late=0,this.framerateSum=h*l}return t.prototype.doForSmoothness=function(t){var e=this.bt(t);if(this.gt(e),e>f?(this.late+=e-f,this.late>.25&&(this.late=0)):e<u&&(this.late+=e-u),this.last=t,this.late<=-h)return this.late+=h,0;if(this.late>=h){var r=Math.floor(this.late/h);return this.late-=r*h,1+r}return 1},t.prototype.doSimplest=function(t){var e=this.bt(t);return this.gt(e),this.last=t,1},t.prototype.doStandard=function(t){var e=this.bt(t);if(this.gt(e),this.late+=e-h,this.late>.25&&(this.late=0),this.last=t,this.late>=h){var r=Math.floor(this.late/h);return this.late-=r*h,1+r}return this.late<=-h?(this.late+=h,0):1},t.prototype.getFramerate=function(){return l/this.framerateSum},t.prototype.gt=function(t){t<.25&&(this.framerateSum=this.framerateSum*(l-1)/l+t)},t.prototype.bt=function(t){return(t-this.last)/1e3},t}();!function(t){t[t.Up=0]="Up",t[t.Down=1]="Down",t[t.Left=2]="Left",t[t.Right=3]="Right",t[t.A=4]="A",t[t.B=5]="B",t[t.L=6]="L",t[t.R=7]="R",t[t.Start=8]="Start",t[t.Select=9]="Select",t[t.NumKeys=10]="NumKeys"}(n||(n={})),function(t){t[t.Up=0]="Up",t[t.Released=1]="Released",t[t.Down=2]="Down",t[t.Pressed=3]="Pressed"}(i||(i={}));var p={ArrowUp:n.Up,ArrowDown:n.Down,ArrowLeft:n.Left,ArrowRight:n.Right,w:n.Up,s:n.Down,a:n.Left,d:n.Right,j:n.A,k:n.B,h:n.L,l:n.R,c:n.A,v:n.B,x:n.L,b:n.R," ":n.Select,Enter:n.Start},d=function(){function t(){this.Key=n;var t=this;this.keyState=new Array(n.NumKeys).fill(i.Up),document.onkeydown=function(e){var r=t.St(e);r>=0&&!t.isDown(r)&&(t.keyState[r]=i.Pressed)},document.onkeyup=function(e){var r=t.St(e);r>=0&&(t.keyState[r]=i.Released)}}return t.prototype.hasToggledDown=function(t){return this.keyState[t]===i.Pressed},t.prototype.hasToggledUp=function(t){return this.keyState[t]===i.Released},t.prototype.isDown=function(t){return this.keyState[t]>=i.Down},t.prototype.Ot=function(){var t=this;this.keyState.forEach(function(e,r){e===i.Pressed&&(t.keyState[r]=i.Down),e===i.Released&&(t.keyState[r]=i.Up)})},t.prototype.St=function(t){return t.key in p?p[t.key]:-1},t}();function m(t,e){return Object(o.t)(t.width,t.height,!1),new Promise(function(r){var n=new a.c(t,e,function(){n._t(),n.input=new d,r(n)})})}function y(t,e){var r=0,n=[],i=new c,o=0,u=0,h=1;window.requestAnimationFrame(function f(l){if(a.a){var c=Math.floor(l/1e3);c!==r&&n.length>0&&(console.log("Upd="+(n.reduce(function(t,e){return t+e})/n.length).toFixed(3)+"ms; r="+o+", s="+u+", u="+n.length+"; "+i.getFramerate().toFixed(2)+"Hz",t.yt()),n.length=0,o=u=0),r=c}var p,d=i.getFramerate();p=d>=s-1&&d<=s+1?i.doSimplest(l):i.doStandard(l);for(var m=0;m<p;m++)if(!(h-- >1)){var y=window.performance.now();t._t(),e.next(),h=t.wt(),n.push(window.performance.now()-y)}a.a&&(p>0&&(o+=1),p>1&&(u+=p-1)),window.requestAnimationFrame(f),t.input.Ot()})}r.d(e,"a",function(){return m}),r.d(e,"b",function(){return y})},,,,,,,function(t,e,r){t.exports=r(11)},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"startStandalone",function(){return startStandalone}),__webpack_require__.d(__webpack_exports__,"startGame",function(){return startGame});var _vdp_runloop__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(3),_vdp_vdp__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(2);__webpack_require__.d(__webpack_exports__,"VDP",function(){return _vdp_vdp__WEBPACK_IMPORTED_MODULE_1__.c});var _vdp_color__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(1);__webpack_require__.d(__webpack_exports__,"color",function(){return _vdp_color__WEBPACK_IMPORTED_MODULE_2__.a});var __read=function(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,i,o=r.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(n=o.next()).done;)a.push(n.value)}catch(t){i={error:t}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return a};function startStandalone(resourceDirectory,scriptFile){Promise.all([window.fetch(scriptFile).then(function(t){if(!t.ok)throw new Error(scriptFile+" not found");return t.text()}),Object(_vdp_runloop__WEBPACK_IMPORTED_MODULE_0__.a)(document.querySelector("#glCanvas"),resourceDirectory)]).then(function(_a){var _b=__read(_a,2),code=_b[0],vdp=_b[1];code=code.replace(/^import .*?;/gm,""),code="(function(vdp){var window ='Please play fair';"+code+";return main;})";var mainFunc=eval(code)(vdp);if(!mainFunc)throw new Error("Check that your script contains a function *main()");Object(_vdp_runloop__WEBPACK_IMPORTED_MODULE_0__.b)(vdp,mainFunc())})}function startGame(t,e){Object(_vdp_runloop__WEBPACK_IMPORTED_MODULE_0__.a)(document.querySelector(t),"./build").then(function(t){window.vdp=t,Object(_vdp_runloop__WEBPACK_IMPORTED_MODULE_0__.b)(t,e(t))})}}])},module.exports=n()},function(t){t.exports={objects:[{$:{id:"4",x:"0",y:"0"},polygon:[{$:{points:"0,0 960,480 1952,480 1952,0"}}]},{$:{id:"5",gid:"3",x:"1056",y:"575.875",width:"32",height:"32"}},{$:{id:"6",gid:"3",x:"1152.13",y:"543.75",width:"32",height:"32"}},{$:{id:"7",gid:"3",x:"1280.25",y:"512.25",width:"32",height:"32"}},{$:{id:"8",gid:"3",x:"1280.5",y:"607.5",width:"32",height:"32"},properties:[{property:[{$:{name:"vx",type:"int",value:"0"}}]}]},{$:{id:"13",gid:"4",x:"1444.5",y:"553",width:"32",height:"32"}},{$:{id:"15",gid:"5",x:"1547",y:"561",width:"32",height:"32"}},{$:{id:"18",gid:"6",x:"1824.33",y:"575.667",width:"32",height:"32"}},{$:{id:"19",gid:"6",x:"1888",y:"576.333",width:"32",height:"32"}},{$:{id:"20",gid:"6",x:"1952.33",y:"562.667",width:"32",height:"32"}},{$:{id:"21",gid:"6",x:"2015.67",y:"602.667",width:"32",height:"32"}},{$:{id:"22",gid:"6",x:"2079.67",y:"574",width:"32",height:"32"}},{$:{id:"31",gid:"5",x:"2244",y:"566",width:"32",height:"32"}},{$:{id:"32",gid:"3",x:"2368",y:"544",width:"32",height:"32"}},{$:{id:"33",gid:"3",x:"2400",y:"640",width:"32",height:"32"}},{$:{id:"34",gid:"6",x:"2457",y:"481",width:"32",height:"32"},properties:[{property:[{$:{name:"fullyOutside",type:"int",value:"64"}}]}]},{$:{id:"40",gid:"6",x:"2511",y:"462.667",width:"32",height:"32"},properties:[{property:[{$:{name:"fullyOutside",type:"int",value:"96"}}]}]},{$:{id:"41",gid:"6",x:"2479",y:"410",width:"32",height:"32"},properties:[{property:[{$:{name:"fullyOutside",type:"int",value:"96"}}]}]},{$:{id:"42",gid:"6",x:"2543.5",y:"374.5",width:"32",height:"32"},properties:[{property:[{$:{name:"fullyOutside",type:"int",value:"96"}}]}]},{$:{id:"43",gid:"6",x:"2497",y:"292.5",width:"32",height:"32"},properties:[{property:[{$:{name:"fullyOutside",type:"int",value:"64"}}]}]},{$:{id:"44",gid:"6",x:"2456",y:"192",width:"32",height:"32"},properties:[{property:[{$:{name:"fullyOutside",type:"int",value:"32"}}]}]},{$:{id:"45",gid:"6",x:"2522",y:"192",width:"32",height:"32"},properties:[{property:[{$:{name:"fullyOutside",type:"int",value:"32"}}]}]},{$:{id:"46",gid:"3",x:"2489",y:"543",width:"32",height:"32"}},{$:{id:"47",gid:"3",x:"2848.5",y:"238.5",width:"32",height:"32"}},{$:{id:"48",gid:"3",x:"2817.5",y:"127.5",width:"32",height:"32"}},{$:{id:"50",gid:"7",x:"2593",y:"48",width:"32",height:"32"}}],firstTile:1,tileTypes:["0-2;6-8;12-14;18-21;24-25;37;45;53;38-41;46-47;66-69;86-89;97-98;102-104","wall","108-113","fire|void|goleft","114-117","void|godown","124","godown"]}},function(t,e,r){"use strict";r.r(e);var n=r(0);let i;const o=r(1),a=1/60,s=.3,u=300,h=3;class f{constructor(t,e){this.x=t,this.y=e,this.z=0,this.vx=this.vy=this.vz=0,this.width=24,this.height=12,this.maxZ=0,this.direction=0,this.canControl=!0}draw(){let t=this.direction;"hit"===this.animState&&(t=4);const e=_.sprite("perso").tile(t),r=_.sprite("shadow"),n=A.transformWithoutShake(this.x,this.y),i=Math.min(1,(u-this.z)/u);let o=this.z<0?this.z/2:this.z/4;this.falling&&!E.listRolesAt(this.x,this.y+o).includes("void")||(_.drawObject(e,n.x-e.w*i/2,n.y-e.h*i+o,{prio:3,width:e.w*i,height:e.h*i}),this.overGround?_.drawObject(r,n.x-r.w/2,n.y-4,{prio:3,transparent:!0}):!this.overGround&&this.z<10&&_.drawObject(r,n.x-r.w/2+6,n.y,{prio:2,transparent:!0,width:12,height:5}))}get left(){return this.x-this.width/2}get right(){return this.x+this.width/2}get top(){return this.y-this.height/2}get bottom(){return this.y+this.height/2}get falling(){return!this.overGround&&this.z>=10&&this.vz>=0}get grounded(){return this.z>=-.1&&this.overGround}get overGround(){return this.maxZ<u}set left(t){this.x=t+this.width/2}notifyGroundOnObject(t){this.maxZ=0}stompedEnemy(){this.vz=-6}replaceInLevel(t,e){this.z=0,this.vz=-10,e.includes("goleft")&&(this.vx=-10),e.includes("goright")&&(this.vx=10),e.includes("goup")&&(this.vy=-10),e.includes("godown")&&(this.vy=10)}takeDamage(t=!0,e=-8){t&&Object.assign(this,{vz:e,vx:-6*Math.sign(this.vx),vy:0}),P.replace(this,"anim",t=>(this.animState="hit",t<60))}update(){const t={x:0,y:0},e=0,r=0;if("hit"!==this.animState&&this.canControl&&(_.input.isDown(_.input.Key.Up)&&(t.y=-2,this.direction=1),_.input.isDown(_.input.Key.Down)&&(t.y=2,this.direction=0),_.input.isDown(_.input.Key.Left)&&(t.x=-2,this.direction=3),_.input.isDown(_.input.Key.Right)&&(t.x=2,this.direction=2),_.input.hasToggledDown(_.input.Key.A)&&this.grounded&&(this.vz=-6)),this.animState="normal",this.vx+=.1*(t.x-this.vx),this.vy+=.1*(t.y-this.vy),this.vz+=s,this.vx+=e,this.vy+=r,this.z+=this.vz,this.z=Math.min(this.maxZ,this.z),this.z>=u&&this.replaceInLevel(this,E.listRolesAt(this.x,this.y)),this.grounded&&(this.vz=0),!this.falling){for(this.x+=this.vx;E.checkCollisionAt(this.left,this.top)||E.checkCollisionAt(this.left,this.bottom);)this.x++;for(;E.checkCollisionAt(this.right,this.top)||E.checkCollisionAt(this.right,this.bottom);)this.x--;for(this.y+=this.vy;E.checkCollisionAt(this.left,this.top)||E.checkCollisionAt(this.right,this.top);)this.y++;for(;E.checkCollisionAt(this.left,this.bottom)||E.checkCollisionAt(this.right,this.bottom);)this.y--}this.left=Math.max(A.x,this.left),E.listRolesAt(this.x,this.y).includes("void")?this.maxZ=u:this.maxZ=0}}class l{constructor(){this.x=0}update(t){this.x+=.5,t.left<this.x&&(t.takeDamage(!1),Object.assign(t,{vx:10,vy:3,vz:-10}));const e=_.sprite("firewall"),r=S/3;let n=10*Math.cos(r),i=10*Math.sin(r);const o=A.transform(this.x,0),a=Math.min(0,-60+o.x);n+=Math.max(0,-60+o.x),a+(n=Math.min(128,e.w+n))>0&&(_.configObjectTransparency({op:"add",blendDst:"#888",blendSrc:"#fff"}),_.drawObject("firewall",a,-15,{prio:8,transparent:!0,width:n,height:290+i}))}}class c{constructor(t){this.width=parseInt(t.width),this.height=parseInt(t.height),this.x=parseInt(t.x),this.y=parseInt(t.y)-this.height,this.z=0}collidesWith(t,{ignoreDepth:e=!1,marginW:r=0,marginH:n=0}={}){return t.right+r>=this.left&&t.left-r<this.right&&t.bottom+n>=this.top&&t.top-n<this.bottom&&(Math.abs(t.z-this.z)<2||e)}destroy(){const t=R.indexOf(this);R.splice(t,1)}draw(){}get left(){return this.x}get right(){return this.x+this.width}get top(){return this.y}get bottom(){return this.y+this.height}get centerX(){return this.x+this.width/2}get centerY(){return this.y+this.height/2}objectPriority(t){return this.top<=t.bottom?h-1:h}update(t){}}class p extends c{constructor(t,e){super(t),this.explosionAnimation=0}draw(t){const e=A.transform(this.x,this.y);if(this.explosionAnimation<3){const t=Math.min(2,Math.ceil(this.explosionAnimation));_.drawObject(_.sprite("level1-more").tile(t),e.x,e.y,{prio:2})}else{const r=50,n=h-(this.top+36<=t.bottom?1:0),i=Math.min(192,(this.explosionAnimation-3)*r),o=_.sprite("flame").offset(0,0,32,25),a=_.sprite("flame").offset(0,25,32,23),s=Math.max(0,i-25),u=32+5*Math.sin(100*this.explosionAnimation);_.drawObject(o,e.x-(u-32)/2,e.y+32-i,{prio:n,width:u,height:Math.min(25,i)}),_.drawObject(a,e.x-(u-32)/2,e.y+32-s,{prio:n,width:u,height:s})}}update(t){this.explosionAnimation>0?this.explosionAnimation+=8*a:t.right>=this.left-48&&(this.explosionAnimation=8*a),this.explosionAnimation>=3&&this.collidesWith(t,{marginW:-8,marginH:-8})&&t.takeDamage()}}class d extends c{constructor(t,e){super(t),this.width=this.height=24,this.followPlayer=e.followPlayer,this.disableFor=0}draw(){let t=S/16%3;const e=A.transform(this.x,this.y);("blinking"!==this.animState||S%2)&&_.drawObject(_.sprite("enemy1").tile(t),e.x,e.y,{prio:2})}update(t){this.followPlayer&&A.isVisible(this)&&this.disableFor<=0&&(this.x-=.25*Math.sign(this.x-t.x),this.y-=.25*Math.sign(this.y-t.y)),this.disableFor=Math.max(0,this.disableFor-a),this.collidesWith(t,{marginW:-4,marginH:-4})&&(t.z<0?(t.stompedEnemy(),this.update=(()=>{}),P.replace(this,"anim",t=>t<30?(this.animState="blinking",!0):(this.destroy(),!1))):(t.takeDamage(),this.disableFor=1))}}class m extends c{constructor(t,e){super(t),this.width=this.height=32,this.visiblePart=0,this.fullyOutside=e.fullyOutside||32,this.spawnY=this.y}draw(t){const e=A.transform(this.x,this.y);this.visiblePart<this.fullyOutside&&(e.x+=3*Math.random()-1,e.y+=3*Math.random()-1);const r=_.sprite("rock-pillar").offset(0,0,32,Math.min(32,this.visiblePart)),n=this.objectPriority(t);if(_.drawObject(r,e.x,e.y,{prio:n}),this.visiblePart>32){const t=_.sprite("rock-pillar").offset(0,32,32,this.visiblePart-32);_.drawObject(t,e.x,e.y+32,{prio:n})}}update(t){A.isVisible(this)&&(this.visiblePart<1?this.visiblePart+=.05:this.visiblePart=Math.min(this.fullyOutside,this.visiblePart+1)),this.y=this.spawnY-this.visiblePart+32;const e=this.visiblePart>32?96-this.visiblePart:0;this.collidesWith(t,{marginW:-8,marginH:0,ignoreDepth:!0})&&t.z<=e&&t.notifyGroundOnObject(this)}}class y extends c{constructor(t,e){super(t),this.y+=8,this.width=this.height=32,this.takingPerso=!1,this.direction="right",this.rideSpeed=3}draw(t){const e=A.transform(this.x,this.y);_.drawObject("cart-lateral",e.x,e.y,{prio:4})}update(t){!this.takingPerso&&this.collidesWith(t,{marginW:0,marginH:32,ignoreDepth:!0})&&(this.takingPerso=!0,t.canControl=!1),this.takingPerso&&("right"===this.direction?(this.x+=this.rideSpeed,E.listRolesAt(this.left,this.bottom).includes("godown")&&(this.direction="down")):"down"===this.direction&&(this.y+=this.rideSpeed),t.x=this.x+14,t.y=this.y+10)}}class x{constructor(t){this.hiPlane=_.readMap(t+"-hi"),this.loPlane=_.readMap(t+"-lo"),this.tileWidth=_.sprite(t).tw,this.tileHeight=_.sprite(t).th,this.width=this.loPlane.width,this.height=this.loPlane.height,this.tileRoles={};for(let t=0;t<o.tileTypes.length;t+=2){const e=o.tileTypes[t].split(";"),r=o.tileTypes[t+1].split("|");for(let t of e){let[e,n]=t.split("-");for(let t=n||e;t>=e;t--)this.tileRoles[t]=r}}}checkCollisionAt(t,e){return this.listRolesAt(t,e).includes("wall")}listRolesAt(t,e){const r=this.getBlockAt(this.loPlane,t,e),n=this.getBlockAt(this.hiPlane,t,e);return(this.tileRoles[r]||[]).concat(this.tileRoles[n]||[])}getBlockAt(t,e,r){return t.getElement(e/this.tileWidth,r/this.tileHeight)}}function v(t){R.push(t)}function g(){if(S%4==0){const t=_.readPalette("level1-objects"),e=S/4%8;t.array[1]=_.color.make(255,160+16*e,0),t.array[2]=_.color.make(160+8*e,0,0),t.array[3]=_.color.make(255,64+8*e,0),[t.array[4],t.array[5],t.array[6]]=[t.array[5],t.array[6],t.array[4]],_.writePalette("level1-objects",t)}if(S%16==1){let t=110+Math.max(0,Math.floor(S/16)%6-2),e=_.readSprite(_.sprite("level1").tile(t),_.CopySource.rom);_.writeSprite(_.sprite("level1").tile(111),e)}if(S%8==2){const t=_.readSprite(_.sprite("level1").tile(108));for(let e=0;e<8;e++)for(let r=0;r<16;r++)t.setElement(r,e,t.getElement((r+1)%16,e));for(let e=8;e<16;e++)for(let r=15;r>=0;r--)t.setElement((r+2)%16,e,t.getElement(r,e));_.writeSprite(_.sprite("level1").tile(108),t)}}function b(){const t=_.palette("blank1").y,e=A.transform(0,0),r=112+Math.floor(e.y/16),n=new _.LineColorArray(0,0);for(let e=0;e<48;e++)n.setLine(e,e/3,t);for(let e=4;e<r;e++){const r=e%4==2?1:0;n.setLine(e+44,Math.min(15,e/4+r),t+1)}for(let e=0;e<256-r;e++)n.setLine(e+r,Math.max(0,Math.min(15,(e-4)/2)),t+2);_.configColorSwap([n]);const i=new _.LineTransformationArray,o=-e.y,a=[-1,0,0,-1,-1,-1,0,0,1,1,0,0,0,0];for(let t=0;t<i.length;t++){const e=a[(t+S+o)%a.length];let r=_.mat3.create();_.mat3.translate(r,r,[e,t+o]),i.setLine(t,r)}_.drawBackgroundTilemap("level1-lo",{scrollX:-e.x,scrollY:-e.y,prio:1,wrap:!1}),_.drawBackgroundTilemap("level1-hi",{scrollX:-e.x,prio:13,wrap:!1,lineTransform:i});const s=_.sprite("level1").tile(93).offset(0,0,48,32);for(let t=-(-e.x/4%48);t<256;t+=48)_.drawObject(s,t,r-32,{prio:1})}function M(t){for(let e=0;e<R.length;e++)A.isVisible(R[e])&&R[e].draw(t)}function w(){S%3==0&&(A.shakeX=3*Math.random()-1,A.shakeY=3*Math.random()-1)}function T(t){for(let e=R.length-1;e>=0;e--)R[e].update(t)}let _,S,E,A=new class{constructor(){this.x=this.y=0,this.shakeX=this.shakeY=0,this.minimumX=0}update(t){const e=t.x-this.x,r=t.y-this.y;e<_.screenWidth/2-16&&(this.x=t.x-(_.screenWidth/2-16)),e>_.screenWidth/2&&(this.x=t.x-_.screenWidth/2),r<_.screenHeight/2-16&&(this.y=t.y-(_.screenHeight/2-16)),r>_.screenHeight/2+16&&(this.y=t.y-(_.screenHeight/2+16)),this.x=Math.min(E.width*E.tileWidth-_.screenWidth,Math.max(this.minimumX,this.x)),this.y=Math.min(E.height*E.tileHeight-_.screenHeight,Math.max(0,this.y))}isVisible(t){const e=this.transform(t.x,t.y);return e.x+t.width>=0&&e.y+t.height>=0&&e.x<_.screenWidth&&e.y<_.screenHeight}get xFinal(){return Math.floor(this.x+this.shakeX)}get yFinal(){return Math.floor(this.y+this.shakeY)}transform(t,e){return{x:Math.floor(t)-this.xFinal,y:Math.floor(e)-this.yFinal}}transformWithoutShake(t,e){return{x:Math.floor(t)-Math.floor(this.x),y:Math.floor(e)-Math.floor(this.y)}}},R=[],P=new class{constructor(){this.coroutines=[]}add(t,e,r,n=null){this.coroutines.push({groupName:e,object:t,updateFn:r,onFinished:n,frameNo:0})}isRunning(t,e){for(let r=0;r<this.coroutines.length;r++)if(this.coroutines[r].object===t&&this.coroutines[r].groupName===e)return!0;return!1}replace(t,e,r,n=null){this.stopGroup(t,e),this.add(t,e,r,n)}stopGroup(t,e){for(let r=0;r<this.coroutines.length;r++)this.coroutines[r].object===t&&this.coroutines[r].groupName===e&&(this.coroutines[r].onFinished&&this.coroutines[r].onFinished(),this.coroutines.splice(r,1),r--)}updateAll(){for(let t=0;t<this.coroutines.length;t++){let e;(e=this.coroutines[t].updateFn?!this.coroutines[t].updateFn(this.coroutines[t].frameNo++):this.coroutines[t].generator.next().done)&&(this.coroutines[t].onFinished&&this.coroutines[t].onFinished(),this.coroutines.splice(t,1),t--)}}};function*O(t){_=t,yield*function*(t){let e=15,r=-100,n=0;(i=t).configBackdropColor("#000");const o=i.readPalette("vdp-logo",i.CopySource.rom),a=i.readPaletteMemory(0,0,16,8,i.CopySource.blank);for(let t=0;t<7;t++)for(let e=0;e<16;e++){const r=i.color.toHsl(o.array[e]);r.h=t/7,r.s=1,r.l*=.7,a.setElement(e,t+1,i.color.makeFromHsl(r))}for(let t=0;t<16;t++)a.setElement(t,0,o.array[t]);i.writePaletteMemory(0,0,16,8,a);const s=i.readMap("vdp-logo"),u=new i.LineTransformationArray;for(;n<116;){if(i.input.hasToggledDown(i.input.Key.Start)||i.input.hasToggledDown(i.input.Key.A)){yield;break}if(r<100){r+=2;for(let t=0;t<u.length;t++){const e=i.mat3.create();let n=Math.max(0,Math.floor(t/2)-r);i.mat3.translate(e,e,[t%2?n:-n,t]),u.setLine(t,e)}}else{const t=Math.floor(.75*s.width),r=Math.floor(.5*s.height);for(let n=0;n<s.height;n++)for(let i=0;i<s.width;i++){let o=8191&s.getElement(i,n),a=Math.sqrt(Math.abs(i-t)*Math.abs(i-t)+Math.abs(n-r)*Math.abs(n-r));a=Math.pow(a,.8),a=Math.max(0,Math.min(16,Math.floor(a/2+e))),s.setElement(i,n,o|a<<13)}i.writeMap("vdp-logo",s),e-=.5,(n+=1)>=100&&i.configFade({color:"#000",factor:16*(n-100)})}const t=i.palette("vdp-logo");t.y=0,i.drawBackgroundTilemap("vdp-logo",{wrap:!1,scrollY:-80,scrollX:-48,winH:140,lineTransform:u,palette:t}),i.drawBackgroundTilemap("vdp-logo-2",{wrap:!1,scrollY:-140,winY:140,winH:Math.max(0,r-20),lineTransform:u,palette:t}),yield}i.writePaletteMemory(0,0,16,8,i.readPaletteMemory(0,0,16,8,i.CopySource.rom)),i.configFade({color:"#000",factor:0})}(t),yield*function*(){const t=new _.LineTransformationArray;let e=0,r=255,n=-4,i=0;for(_.configBackdropColor("#048");r<256;){(_.input.hasToggledDown(_.input.Key.Start)||_.input.hasToggledDown(_.input.Key.A))&&(n=16),e++,r=Math.max(0,r+n);for(let r=0;r<_.screenHeight;r++){const n=r/(_.screenHeight-1),i=1-1.5*n,o=1-1*n,a=_.mat3.create();let s=(e+r/i)%320;s%320>=160&&(s=320-s),r<128?(_.mat3.translate(a,a,[128,0]),_.mat3.scale(a,a,[1/o,1]),_.mat3.translate(a,a,[-128,s])):_.mat3.translate(a,a,[0,161]),t.setLine(r,a)}const o=5*Math.sin(i/30);i++,_.configFade({color:"#008",factor:r}),_.drawBackgroundTilemap("title-screen",{wrap:!0,lineTransform:t}),_.drawBackgroundTilemap("title-barque",{scrollY:o}),_.drawObject(_.sprite("perso").tile(1),154,130-o,{width:48,height:48}),yield}}();let e=255;const r=new f(100,128),n=new l;let a=0;for(E=new x("level1"),S=0,function(){const t=_.palette("blank1").y,e=_.readPaletteMemory(0,t,16,3,_.CopySource.blank);for(let t=0;t<16;t++)e.setElement(t,0,_.color.make(16*t,0,136-8*t));for(let t=1;t<16;t++)e.setElement(t,1,_.color.make(255,16*t,0));const r=_.color.make("#d4a26e");for(let t=0;t<16;t++)e.setElement(t,2,_.color.sub(r,_.color.make(16*t,16*t,16*t)));_.writePaletteMemory(0,t,16,3,e)}(),function(){for(let t=0;t<o.objects.length;t++){const e=o.objects[t];if(!e.$.gid)continue;const r=parseInt(e.$.gid-o.firstTile),n={};if(e.properties&&e.properties[0].property.forEach(t=>n[t.$.name]=t.$.value),2===r)v(new p(e.$,n));else if(3===r)v(new d(e.$,n));else if(4===r)v(new d(e.$,Object.assign({followPlayer:!0},n)));else if(5===r)v(new m(e.$,n));else{if(6!==r)throw new Error(`Unsupported object type ${r}`);v(new y(e.$,n))}}}();e<256;)_.configObjectTransparency({op:"add",blendDst:"#888",blendSrc:"#fff"}),r.update(),A.update(r),T(r),g(),P.updateAll(),0===a?(e=Math.max(0,e-16),w(),n.x-A.x<-0&&(n.x=A.x-0),r.x>=960&&(a=1)):1===a?(A.minimumX=Math.min(960,A.x+1),n.x=Math.min(n.x+4,925),A.x<960&&w(),r.x>=2600&&r.y>=800&&(a=2)):2===a&&(e+=16),_.configFade({color:"#008",factor:e}),b(),r.draw(),M(r),n.update(r),S++,yield}Object(n.startGame)("#glCanvas",t=>O(t))}]);